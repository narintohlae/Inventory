<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลจาก Google Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap">
    <!-- SortableJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .sortable-ghost {
            background-color: #c0e2ff;
            opacity: 0.7;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        #table-body tr:not(.bg-gray-200), #category-list > div {
            cursor: grab;
        }
        #item-settings-modal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 lg:w-1/2">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">ตารางแสดงข้อมูล</h1>
            <p class="text-gray-500 mt-2">ข้อมูลล่าสุดจาก Google Sheet</p>
        </header>

        <!-- Auth Container -->
        <div id="auth-container" class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <!-- Login Form -->
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">เข้าสู่ระบบ</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">เข้าสู่ระบบ</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    <p class="text-sm text-center text-gray-600 mt-4">
                        ยังไม่มีบัญชี? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">สมัครสมาชิกที่นี่</button>
                    </p>
                </form>

                <!-- Registration Form -->
                <form id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">สมัครสมาชิกใหม่</h2>
                     <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">สมัครสมาชิก</button>
                    <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    <p class="text-sm text-center text-gray-600 mt-4">
                        มีบัญชีอยู่แล้ว? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">เข้าสู่ระบบที่นี่</button>
                    </p>
                </form>
            </div>
        </div>


        <!-- App Container (Hidden by default) -->
        <div id="app-container" class="hidden">
            <!-- User Info and Logout -->
            <div class="mb-8 bg-white rounded-lg shadow-md p-4 flex justify-between items-center">
                <div>
                     <p class="text-sm text-gray-500">ลงชื่อเข้าใช้ในชื่อ:</p>
                     <p id="user-email" class="font-semibold text-gray-800"></p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">ออกจากระบบ</button>
            </div>

             <!-- Navigation Tabs -->
            <div class="mb-8 border-b border-gray-200">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="nav-products" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                        รายการสินค้า
                    </button>
                    <button id="nav-requisition" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                        รายการเบิกของ
                    </button>
                    <button id="nav-history" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                        ประวัติ
                    </button>
                </nav>
            </div>
            
            <!-- Product List View -->
            <div id="product-list-view">
                <!-- Category Management Section -->
                <div class="mb-8 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">จัดการหมวดหมู่และหัวข้อ</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="category-input" placeholder="ใส่ชื่อหมวดหมู่ที่นี่..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-category-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            เพิ่มหมวดหมู่
                        </button>
                         <button id="add-header-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            เพิ่มหัวข้อ
                        </button>
                    </div>
                     <div class="mt-4">
                        <button id="auto-requisition-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            เบิกของอัตโนมัติ
                        </button>
                    </div>
                    <div id="category-list-container" class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">หมวดหมู่ของฉัน:</h3>
                        <p class="text-sm text-gray-500 mb-2">คลิกที่ชื่อหมวดหมู่เพื่อกรองข้อมูล</p>
                        <div id="category-list" class="flex flex-wrap gap-2 items-center">
                            <!-- Categories will be injected here by JavaScript -->
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button id="clear-filter-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                แสดงทั้งหมด
                            </button>
                            <button id="show-hidden-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                แสดงแถวที่ซ่อน
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Container for the table and loading/error states -->
                <div id="data-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div id="loading" class="p-8 text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
                    </div>
                    <div id="error" class="hidden p-8 text-center text-red-600 bg-red-50 rounded-lg">
                        <h3 class="font-bold text-lg">เกิดข้อผิดพลาด</h3>
                        <p id="error-message" class="mt-2">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="data-table" class="hidden w-full min-w-full divide-y divide-gray-200">
                            <thead id="table-head" class="bg-gray-50"></thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="no-data" class="hidden p-8 text-center text-gray-500">
                        <p>ไม่พบข้อมูล</p>
                    </div>
                </div>
            </div>

            <!-- Requisition List View -->
            <div id="requisition-view" class="hidden">
                 <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">รายการเบิกของ</h2>
                        <button id="confirm-requisition-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 disabled:bg-gray-400">
                            ยืนยันการเบิกของ
                        </button>
                    </div>
                     <div class="overflow-x-auto">
                        <table class="w-full min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider w-16">ลำดับ</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">สินค้า</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">จำนวนเบิก</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">หน่วย</th>
                                    <th class="py-3 px-6 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="requisition-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Requisition items will be injected here -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

             <!-- History View -->
            <div id="history-view" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ประวัติการเบิกของ</h2>
                    <div id="history-list-container" class="space-y-6">
                        <!-- History items will be injected here -->
                    </div>
                </div>
            </div>

        </div>

        <footer class="text-center mt-8 text-gray-400 text-sm">
            <p>สร้างโดย Gemini</p>
        </footer>
    </div>
    
    <!-- Item Settings Modal -->
    <div id="item-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-item-name">ตั้งค่าสินค้า</h3>
                <div class="mt-4 px-7 py-3 space-y-4 text-left">
                    <div>
                        <label for="reorder-point" class="block text-sm font-medium text-gray-700">จุดเบิกของ (Reorder Point)</label>
                        <input type="number" id="reorder-point" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น 10">
                    </div>
                    <div>
                        <label for="reorder-quantity" class="block text-sm font-medium text-gray-700">จำนวนเบิกอัตโนมัติ</label>
                         <input type="number" id="reorder-quantity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น 50">
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        ตกลง
                    </button>
                    <button id="modal-cancel-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel, getDocs, setDoc, getDoc, Timestamp, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const sheetUrl = 'https://script.google.com/macros/s/AKfycbyW37lyYs-WKqsSyoG8PO2emr3bH1J0CnkNWKnZ409-y43qo-hbOy9UFO6L3dnSP8FlHg/exec';

            // DOM Elements
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const loginErrorEl = document.getElementById('login-error');
            const registerErrorEl = document.getElementById('register-error');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const userEmailEl = document.getElementById('user-email');
            const logoutBtn = document.getElementById('logout-btn');

            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const errorMessageEl = document.getElementById('error-message');
            const noDataEl = document.getElementById('no-data');
            const tableEl = document.getElementById('data-table');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            const categoryInput = document.getElementById('category-input');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const addHeaderBtn = document.getElementById('add-header-btn');
            const categoryList = document.getElementById('category-list');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const showHiddenBtn = document.getElementById('show-hidden-btn');

            // New UI Elements
            const navProductsBtn = document.getElementById('nav-products');
            const navRequisitionBtn = document.getElementById('nav-requisition');
            const navHistoryBtn = document.getElementById('nav-history');
            const productListView = document.getElementById('product-list-view');
            const requisitionView = document.getElementById('requisition-view');
            const historyView = document.getElementById('history-view');
            const autoRequisitionBtn = document.getElementById('auto-requisition-btn');
            const requisitionListBody = document.getElementById('requisition-list-body');
            const confirmRequisitionBtn = document.getElementById('confirm-requisition-btn');
            const historyListContainer = document.getElementById('history-list-container');
            const itemSettingsModal = document.getElementById('item-settings-modal');
            const modalItemName = document.getElementById('modal-item-name');
            const reorderPointInput = document.getElementById('reorder-point');
            const reorderQuantityInput = document.getElementById('reorder-quantity');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            // App State
            let allRecords = [];
            let currentRecords = [];
            let categories = []; 
            let customRows = new Map();
            let itemSettings = new Map();
            let itemColumnName = '';
            let triggerStockColumnName = 'รักษ์ยา';
            let calculationStockColumnName = 'เบบี้ช็อป';
            let unitColumnName = 'หน่วย';
            let hiddenItemIds = new Set();
            let sortableInstance = null;
            let categorySortableInstance = null;
            let sortOrdersMap = {};
            let categoryOrder = [];
            let activeCategoryName = null;
            let requisitionList = [];
            let historyList = [];
            let currentEditingItemId = null;
            
            // Firebase State
            let userId = null;
            let categoriesCollectionRef, hiddenItemsCollectionRef, sortOrdersDocRef, customRowsCollectionRef, categoryOrderDocRef, itemSettingsCollectionRef, requisitionListCollectionRef, requisitionHistoryCollectionRef, countersDocRef;
            let unsubscribeCategories, unsubscribeHiddenItems, unsubscribeSortOrders, unsubscribeCustomRows, unsubscribeCategoryOrder, unsubscribeItemSettings, unsubscribeRequisitionList, unsubscribeHistory;

            // Firebase Config
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = {
              apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY",
              authDomain: "pos-6-23035.firebaseapp.com",
              projectId: "pos-6-23035",
              storageBucket: "pos-6-23035.appspot.com",
              messagingSenderId: "1025982856125",
              appId: "1:1025982856125:web:28e47483570949900f30d4"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug');

            // --- Auth State Management ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    userEmailEl.textContent = user.email;
                    initializeListeners(userId);
                    if(allRecords.length === 0) fetchData(); 
                } else {
                    userId = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    [unsubscribeCategories, unsubscribeHiddenItems, unsubscribeSortOrders, unsubscribeCustomRows, unsubscribeCategoryOrder, unsubscribeItemSettings, unsubscribeRequisitionList, unsubscribeHistory].forEach(unsub => unsub && unsub());
                    categories = []; hiddenItemIds.clear(); sortOrdersMap = {}; categoryOrder = []; customRows.clear(); itemSettings.clear(); requisitionList = []; historyList = [];
                    displayCategories(); 
                }
            });
            
            function initializeListeners(currentUserId) {
                 if (!currentUserId) return;
                 const userPath = `artifacts/${appId}/users/${currentUserId}`;
                 // Initialize doc/collection refs
                 categoriesCollectionRef = collection(db, `${userPath}/categories`);
                 hiddenItemsCollectionRef = collection(db, `${userPath}/hiddenItems`);
                 sortOrdersDocRef = doc(db, `${userPath}/settings`, 'sortOrders');
                 customRowsCollectionRef = collection(db, `${userPath}/customRows`);
                 categoryOrderDocRef = doc(db, `${userPath}/settings`, 'categoryOrder');
                 itemSettingsCollectionRef = collection(db, `${userPath}/itemSettings`);
                 requisitionListCollectionRef = collection(db, `${userPath}/requisitionList`);
                 requisitionHistoryCollectionRef = collection(db, `${userPath}/requisitionHistory`);
                 countersDocRef = doc(db, `${userPath}/settings`, 'counters');

                 // Start listeners
                 initializeCategoryListener();
                 initializeHiddenItemsListener();
                 initializeSortOrdersListener();
                 initializeCustomRowsListener();
                 initializeCategoryOrderListener();
                 initializeItemSettingsListener();
                 initializeRequisitionListListener();
                 initializeHistoryListener();
            }

            // --- Auth UI & Forms --- (Omitted for brevity, no changes)
            showRegisterBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', () => { registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); loginErrorEl.textContent = ''; try { await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value); } catch (error) { loginErrorEl.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง"; } });
            registerForm.addEventListener('submit', async (e) => { e.preventDefault(); registerErrorEl.textContent = ''; try { await createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value); } catch (error) { if (error.code === 'auth/weak-password') registerErrorEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร'; else if (error.code === 'auth/email-already-in-use') registerErrorEl.textContent = 'อีเมลนี้ถูกใช้งานแล้ว'; else if (error.code === 'auth/operation-not-allowed') registerErrorEl.textContent = 'การสมัครด้วยอีเมลยังไม่ถูกเปิดใช้งานในระบบ'; else registerErrorEl.textContent = 'เกิดข้อผิดพลาดในการสมัคร'; } });
            logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); } });
            
            // --- Firestore Listeners ---
            function initializeCategoryListener() { if (unsubscribeCategories) unsubscribeCategories(); unsubscribeCategories = onSnapshot(categoriesCollectionRef, (snap) => { categories = snap.docs.map(doc => ({ id: doc.id, name: doc.data().name })); displayCategories(); }, (err) => showError("โหลดหมวดหมู่ไม่สำเร็จ"));}
            function initializeHiddenItemsListener() { if (unsubscribeHiddenItems) unsubscribeHiddenItems(); unsubscribeHiddenItems = onSnapshot(hiddenItemsCollectionRef, (snap) => { hiddenItemIds = new Set(snap.docs.map(doc => doc.id)); if (allRecords.length > 0) displayData(currentRecords); updateShowHiddenButtonVisibility(); }, (err) => showError("โหลดรายการที่ซ่อนไม่สำเร็จ"));}
            function initializeSortOrdersListener() { if (unsubscribeSortOrders) unsubscribeSortOrders(); unsubscribeSortOrders = onSnapshot(sortOrdersDocRef, (snap) => { sortOrdersMap = (snap.exists() && snap.data().orders) ? snap.data().orders : {}; if (allRecords.length > 0) displayData(currentRecords); }, (err) => showError("โหลดลำดับจัดเรียงไม่สำเร็จ"));}
            function initializeCategoryOrderListener() { if (unsubscribeCategoryOrder) unsubscribeCategoryOrder(); unsubscribeCategoryOrder = onSnapshot(categoryOrderDocRef, (snap) => { categoryOrder = (snap.exists() && snap.data().order) ? snap.data().order : []; if (categories.length > 0) displayCategories(); }, (err) => showError("โหลดลำดับหมวดหมู่ไม่สำเร็จ"));}
            function initializeCustomRowsListener() { if(unsubscribeCustomRows) unsubscribeCustomRows(); unsubscribeCustomRows = onSnapshot(customRowsCollectionRef, (snap) => { customRows.clear(); snap.docs.forEach(doc => customRows.set(doc.id, doc.data())); if (allRecords.length > 0) displayData(currentRecords); }, (err) => showError("โหลดหัวข้อไม่สำเร็จ"));}
            function initializeItemSettingsListener() { if(unsubscribeItemSettings) unsubscribeItemSettings(); unsubscribeItemSettings = onSnapshot(itemSettingsCollectionRef, (snap) => { itemSettings.clear(); snap.docs.forEach(doc => itemSettings.set(doc.id, doc.data())); }, (err) => showError("โหลดการตั้งค่าสินค้าไม่สำเร็จ"));}
            function initializeRequisitionListListener() { if(unsubscribeRequisitionList) unsubscribeRequisitionList(); unsubscribeRequisitionList = onSnapshot(requisitionListCollectionRef, (snap) => { requisitionList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); displayRequisitionList(); }, (err) => showError("โหลดรายการเบิกของไม่สำเร็จ"));}
            function initializeHistoryListener() { if(unsubscribeHistory) unsubscribeHistory(); unsubscribeHistory = onSnapshot(requisitionHistoryCollectionRef, (snap) => { historyList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds); displayHistory(); }, (err) => showError("โหลดประวัติไม่สำเร็จ"));}

            // --- Firestore Write Functions ---
            async function saveCurrentSortOrder(newOrder) { if (!sortOrdersDocRef) return; const key = activeCategoryName || '__global__'; try { const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {}; currentOrders[key] = newOrder; await setDoc(sortOrdersDocRef, { orders: currentOrders }); } catch (error) { showError("บันทึกการจัดเรียงไม่สำเร็จ"); } }
            async function saveCategoryOrder(newOrder) { if (!categoryOrderDocRef) return; try { await setDoc(categoryOrderDocRef, { order: newOrder }); } catch (error) { showError("บันทึกการจัดเรียงหมวดหมู่ไม่สำเร็จ"); } }
            async function hideItem(itemId) { if (!hiddenItemsCollectionRef || !itemId) return; try { await setDoc(doc(hiddenItemsCollectionRef, itemId), { hidden: true }); } catch (error) { showError("ซ่อนรายการไม่สำเร็จ"); } }
            async function unhideItems(ids) { if (!hiddenItemsCollectionRef || !ids || ids.length === 0) return; try { await Promise.all(ids.map(id => deleteDoc(doc(hiddenItemsCollectionRef, id)))); } catch (error) { showError("แสดงรายการที่ซ่อนไม่สำเร็จ"); } }
            async function addCategory() { if (!categoriesCollectionRef) return; const name = categoryInput.value.trim(); if (name && !categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { try { await addDoc(categoriesCollectionRef, { name }); categoryInput.value = ''; } catch(error) { showError("เพิ่มหมวดหมู่ไม่สำเร็จ"); } } else if (name) alert('มีหมวดหมู่นี้อยู่แล้ว'); }
            async function editCategory(id, oldName) { if (!categoriesCollectionRef) return; const newName = prompt('แก้ไขชื่อหมวดหมู่:', oldName); if (newName && newName.trim() && newName.trim() !== oldName) { try { await updateDoc(doc(categoriesCollectionRef, id), { name: newName.trim() }); } catch(error) { showError("แก้ไขหมวดหมู่ไม่สำเร็จ"); } } }
            async function deleteCategory(id) { if (!categoriesCollectionRef) return; try { await deleteDoc(doc(categoriesCollectionRef, id)); displayData(allRecords); clearFilterBtn.classList.add('hidden'); } catch(error) { showError("ลบหมวดหมู่ไม่สำเร็จ"); } }
            async function addHeaderRow() { const text = prompt("ใส่ชื่อหัวข้อ:"); if (!text || !text.trim()) return; try { const key = activeCategoryName || '__global__'; const newDocRef = await addDoc(customRowsCollectionRef, { text: text.trim(), categoryName: activeCategoryName }); const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {}; const currentCategoryOrder = currentOrders[key] || []; currentOrders[key] = [newDocRef.id, ...currentCategoryOrder]; await setDoc(sortOrdersDocRef, { orders: currentOrders }); } catch(error) { showError("เพิ่มหัวข้อไม่สำเร็จ"); } }
            async function editHeaderRow(id, oldText) { const newText = prompt("แก้ไขชื่อหัวข้อ:", oldText); if (newText && newText.trim() && newText.trim() !== oldText) { try { await updateDoc(doc(customRowsCollectionRef, id), { text: newText.trim() }); } catch (error) { showError("แก้ไขหัวข้อไม่สำเร็จ"); } } }
            async function deleteHeaderRow(id) { if (!customRowsCollectionRef || !sortOrdersDocRef) return; try { const key = activeCategoryName || '__global__'; const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {}; const currentCategoryOrder = currentOrders[key] || []; currentOrders[key] = currentCategoryOrder.filter(itemId => itemId !== id); await setDoc(sortOrdersDocRef, { orders: currentOrders }); await deleteDoc(doc(customRowsCollectionRef, id)); } catch (error) { showError("ลบหัวข้อไม่สำเร็จ"); } }

            // --- Requisition Functions ---
            async function saveItemSettings() { if (!itemSettingsCollectionRef || !currentEditingItemId) return; const point = parseInt(reorderPointInput.value, 10); const quantity = parseInt(reorderQuantityInput.value, 10); const settings = { reorderPoint: isNaN(point) ? null : point, reorderQuantity: isNaN(quantity) ? null : quantity }; try { await setDoc(doc(itemSettingsCollectionRef, currentEditingItemId), settings); closeItemSettingsModal(); } catch(error) { showError("บันทึกการตั้งค่าไม่สำเร็จ"); } }
            async function generateRequisition() {
                if (!itemSettingsCollectionRef || allRecords.length === 0) { alert('ยังไม่มีข้อมูลสินค้าหรือการตั้งค่า'); return; }
                if (allRecords.length > 0) { const firstRecordKeys = Object.keys(allRecords[0]); if (!firstRecordKeys.includes(triggerStockColumnName) || !firstRecordKeys.includes(calculationStockColumnName)) { alert(`ไม่พบคอลัมน์: "${triggerStockColumnName}" หรือ "${calculationStockColumnName}"`); return; } }
                const itemsToRequisition = [];
                allRecords.forEach(record => {
                    const itemId = record[itemColumnName];
                    const settings = itemSettings.get(itemId);
                    if (settings && typeof settings.reorderPoint === 'number' && typeof settings.reorderQuantity === 'number') {
                        const triggerStock = parseInt(record[triggerStockColumnName], 10);
                        if (!isNaN(triggerStock) && triggerStock <= settings.reorderPoint) {
                            const calculationStock = parseInt(record[calculationStockColumnName], 10);
                            let finalQuantity = settings.reorderQuantity;
                            if (!isNaN(calculationStock) && calculationStock > 0) {
                                const halfCalcStock = 0.5 * calculationStock;
                                if (settings.reorderQuantity > halfCalcStock) {
                                    const halfAutoQty = 0.5 * settings.reorderQuantity;
                                    finalQuantity = (halfAutoQty > halfCalcStock) ? halfCalcStock : halfAutoQty;
                                }
                            }
                            const roundedQuantity = Math.floor(finalQuantity);
                            if (roundedQuantity > 0) { itemsToRequisition.push({ id: itemId, name: record[itemColumnName], quantity: roundedQuantity, unit: record[unitColumnName] || 'ชิ้น' }); }
                        }
                    }
                });
                if (itemsToRequisition.length === 0) { alert('ไม่พบสินค้าที่ถึงจุดเบิกของตามเงื่อนไข'); return; }
                try { const batch = writeBatch(db); itemsToRequisition.forEach(item => { const docRef = doc(requisitionListCollectionRef, item.id); batch.set(docRef, { name: item.name, quantity: item.quantity, unit: item.unit }); }); await batch.commit(); alert(`สร้างรายการเบิก ${itemsToRequisition.length} รายการสำเร็จ!`); switchView('requisition'); } catch (error) { showError("สร้างรายการเบิกไม่สำเร็จ"); }
            }
            async function deleteRequisitionItem(id) { if(!requisitionListCollectionRef) return; try { await deleteDoc(doc(requisitionListCollectionRef, id)); } catch (error) { showError("ลบรายการเบิกไม่สำเร็จ"); } }
            async function confirmRequisition() {
                if (!requisitionListCollectionRef || requisitionList.length === 0) return;
                try {
                    await runTransaction(db, async (transaction) => {
                        const counterSnap = await transaction.get(countersDocRef);
                        const currentCounter = counterSnap.exists() ? (counterSnap.data().requisitionNumber || 0) : 0;
                        const newCounter = currentCounter + 1;
                        
                        const now = new Date();
                        const reqNumber = `REQ-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}-${newCounter.toString().padStart(4, '0')}`;

                        const historyDocRef = doc(requisitionHistoryCollectionRef);
                        transaction.set(historyDocRef, {
                            requisitionNumber: reqNumber,
                            timestamp: Timestamp.now(),
                            items: requisitionList.map(({id, ...rest}) => rest)
                        });

                        requisitionList.forEach(item => {
                            transaction.delete(doc(requisitionListCollectionRef, item.id));
                        });

                        transaction.set(countersDocRef, { requisitionNumber: newCounter }, { merge: true });
                    });
                    alert('ยืนยันการเบิกของเรียบร้อย');
                } catch (error) {
                    console.error("Transaction failed: ", error);
                    showError("ยืนยันการเบิกของไม่สำเร็จ");
                }
            }


            // --- UI Display & Helper Functions ---
            function displayCategories() { if (categorySortableInstance) categorySortableInstance.destroy(); categoryList.innerHTML = ''; if (!userId) return; if (categories.length === 0) { categoryList.innerHTML = '<p class="text-gray-500 text-sm">ยังไม่มีหมวดหมู่</p>'; return; } const sortedCategories = [...categories].sort((a, b) => { const indexA = categoryOrder.indexOf(a.id); const indexB = categoryOrder.indexOf(b.id); if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name, 'th'); if (indexA === -1) return 1; if (indexB === -1) return -1; return indexA - indexB; }); sortedCategories.forEach((category) => { const categoryEl = document.createElement('div'); categoryEl.dataset.id = category.id; categoryEl.className = 'flex items-center bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 transition-shadow duration-200'; const nameBtn = document.createElement('button'); nameBtn.textContent = category.name; nameBtn.className = 'focus:outline-none'; nameBtn.title = `กรองด้วย "${category.name}"`; nameBtn.onclick = () => { if (!itemColumnName) return; const filtered = allRecords.filter(r => r[itemColumnName]?.toLowerCase().includes(category.name.toLowerCase())); noDataEl.querySelector('p').textContent = `ไม่พบสินค้าในหมวดหมู่ "${category.name}"`; activeCategoryName = category.name; displayData(filtered); clearFilterBtn.classList.remove('hidden'); document.querySelectorAll('#category-list > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500')); categoryEl.classList.add('ring-2', 'ring-blue-500'); }; const editBtn = document.createElement('button'); editBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>`; editBtn.className = 'ml-2 text-gray-500 hover:text-blue-600'; editBtn.onclick = () => editCategory(category.id, category.name); const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`; deleteBtn.className = 'ml-1 text-gray-500 hover:text-red-600'; deleteBtn.onclick = () => deleteCategory(category.id); categoryEl.append(nameBtn, editBtn, deleteBtn); categoryList.appendChild(categoryEl); }); categorySortableInstance = new Sortable(categoryList, { animation: 150, ghostClass: 'sortable-ghost', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: (evt) => { const newOrder = Array.from(categoryList.querySelectorAll('div')).map(el => el.dataset.id); saveCategoryOrder(newOrder); } }); }
            async function fetchData() { try { loadingEl.classList.remove('hidden'); const response = await fetch(sheetUrl); if (!response.ok) throw new Error(`Network: ${response.statusText}`); const data = await response.json(); if (!Array.isArray(data.data) || data.data.length === 0) { showNoData(); return; } allRecords = data.data; itemColumnName = Object.keys(allRecords[0])[0] || ''; if (!itemColumnName) { showError("ข้อมูลไม่มีคอลัมน์"); return; } displayData(allRecords); } catch (error) { showError(error.message); } finally { loadingEl.classList.add('hidden'); } }
            function displayData(records) { currentRecords = records; tableHead.innerHTML = ''; tableBody.innerHTML = ''; if (sortableInstance) sortableInstance.destroy(); const allRecordsMap = new Map(allRecords.map(r => [r[itemColumnName], r])); const currentRecordIds = new Set(records.map(r => r[itemColumnName])); const sortKey = activeCategoryName || '__global__'; const currentItemOrder = sortOrdersMap[sortKey] || []; const orderedIdSet = new Set(currentItemOrder); const combinedOrder = [...currentItemOrder]; for(const record of records) { const id = record[itemColumnName]; if(!orderedIdSet.has(id)) combinedOrder.push(id); } const displayOrder = combinedOrder.filter(id => customRows.has(id) || currentRecordIds.has(id)); const visibleIds = new Set(displayOrder.filter(id => !hiddenItemIds.has(id))); if (visibleIds.size === 0) { tableEl.classList.add('hidden'); noDataEl.classList.remove('hidden'); return; } noDataEl.classList.add('hidden'); tableEl.classList.remove('hidden'); const headers = allRecords.length > 0 ? Object.keys(allRecords[0]) : []; const headerRow = document.createElement('tr'); headers.forEach(header => { const th = document.createElement('th'); th.scope = 'col'; th.className = `px-2 sm:px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${header === itemColumnName ? 'w-2/5' : 'w-auto'}`; th.textContent = header.replace(/_/g, ' '); headerRow.appendChild(th); }); tableHead.appendChild(headerRow); displayOrder.forEach(id => { if (!visibleIds.has(id)) return; if(customRows.has(id)){ const rowData = customRows.get(id); if (rowData.categoryName === activeCategoryName) { const row = document.createElement('tr'); row.dataset.id = id; row.className = 'bg-gray-200 font-bold'; const cell = document.createElement('td'); cell.colSpan = headers.length; cell.className = 'px-4 py-2 text-gray-800'; const contentWrapper = document.createElement('div'); contentWrapper.className = 'flex justify-between items-center'; const textSpan = document.createElement('span'); textSpan.textContent = rowData.text; const buttonsWrapper = document.createElement('div'); const editBtn = document.createElement('button'); editBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>`; editBtn.className = 'ml-2 text-gray-500 hover:text-blue-600'; editBtn.onclick = (e) => { e.stopPropagation(); editHeaderRow(id, rowData.text); }; const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`; deleteBtn.className = 'ml-1 text-gray-500 hover:text-red-600'; deleteBtn.onclick = (e) => { e.stopPropagation(); deleteHeaderRow(id); }; buttonsWrapper.append(editBtn, deleteBtn); contentWrapper.append(textSpan, buttonsWrapper); cell.appendChild(contentWrapper); row.appendChild(cell); tableBody.appendChild(row); } } else if (allRecordsMap.has(id)) { const record = allRecordsMap.get(id); const row = document.createElement('tr'); row.dataset.id = id; row.className = 'hover:bg-gray-50'; let clickTimeout = null; row.addEventListener('click', () => { if (clickTimeout) { clearTimeout(clickTimeout); clickTimeout = null; hideItem(id); } else { clickTimeout = setTimeout(() => { openItemSettingsModal(record); clickTimeout = null; }, 300); } }); headers.forEach(header => { const td = document.createElement('td'); td.className = `px-2 sm:px-6 py-2 text-sm text-gray-700 whitespace-normal break-all ${header === itemColumnName ? 'w-2/5' : 'w-auto'}`; td.textContent = record[header]; row.appendChild(td); }); tableBody.appendChild(row); } }); sortableInstance = new Sortable(tableBody, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: (evt) => { const newOrder = Array.from(tableBody.querySelectorAll('tr')).map(row => row.dataset.id); saveCurrentSortOrder(newOrder); } }); updateShowHiddenButtonVisibility(); }
            function displayRequisitionList() {
                requisitionListBody.innerHTML = '';
                if (requisitionList.length === 0) {
                    requisitionListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">ไม่มีรายการที่ต้องเบิก</td></tr>';
                    confirmRequisitionBtn.disabled = true;
                    return;
                }
                confirmRequisitionBtn.disabled = false;
                requisitionList.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="delete-req-btn text-red-600 hover:text-red-900" data-id="${item.id}">ลบ</button>
                        </td>`;
                    requisitionListBody.appendChild(row);
                });
            }
            function displayHistory() { historyListContainer.innerHTML = ''; if (historyList.length === 0) { historyListContainer.innerHTML = '<p class="text-center py-4 text-gray-500">ยังไม่มีประวัติการเบิก</p>'; return; } historyList.forEach(historyItem => { const date = historyItem.timestamp.toDate(); const formattedDate = `${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}`; const card = document.createElement('div'); card.className = 'bg-gray-50 rounded-lg p-4 shadow'; const tableRows = historyItem.items.map((item, index) => `<tr><td class="py-2 px-4 text-sm text-gray-600">${index + 1}</td><td class="py-2 px-4 text-sm text-gray-800">${item.name}</td><td class="py-2 px-4 text-sm text-gray-800">${item.quantity}</td><td class="py-2 px-4 text-sm text-gray-600">${item.unit}</td></tr>`).join(''); card.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-gray-800">${historyItem.requisitionNumber}</h3><span class="text-sm text-gray-500">${formattedDate}</span></div><div class="overflow-x-auto"><table class="w-full"><thead><tr><th class="py-2 px-4 bg-gray-200 text-xs text-gray-600 font-medium text-left">ลำดับ</th><th class="py-2 px-4 bg-gray-200 text-xs text-gray-600 font-medium text-left">สินค้า</th><th class="py-2 px-4 bg-gray-200 text-xs text-gray-600 font-medium text-left">จำนวน</th><th class="py-2 px-4 bg-gray-200 text-xs text-gray-600 font-medium text-left">หน่วย</th></tr></thead><tbody class="divide-y divide-gray-200">${tableRows}</tbody></table></div>`; historyListContainer.appendChild(card); });}
            function openItemSettingsModal(record) { currentEditingItemId = record[itemColumnName]; const settings = itemSettings.get(currentEditingItemId) || {}; modalItemName.textContent = `ตั้งค่า: ${currentEditingItemId}`; reorderPointInput.value = settings.reorderPoint || ''; reorderQuantityInput.value = settings.reorderQuantity || ''; itemSettingsModal.classList.remove('hidden'); }
            function closeItemSettingsModal() { itemSettingsModal.classList.add('hidden'); currentEditingItemId = null; }
            function switchView(viewName) { const views = { products: productListView, requisition: requisitionView, history: historyView }; const navs = { products: navProductsBtn, requisition: navRequisitionBtn, history: navHistoryBtn }; Object.values(views).forEach(v => v.classList.add('hidden')); Object.values(navs).forEach(n => { n.classList.remove('text-blue-600', 'border-blue-600'); n.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent'); }); views[viewName].classList.remove('hidden'); navs[viewName].classList.add('text-blue-600', 'border-blue-600'); navs[viewName].classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');}
            function showError(message) { errorMessageEl.textContent = `เกิดข้อผิดพลาด: ${message}`; errorEl.classList.remove('hidden'); }
            function showNoData() { noDataEl.querySelector('p').textContent = 'ไม่พบข้อมูล'; noDataEl.classList.remove('hidden'); tableEl.classList.add('hidden'); }
            function updateShowHiddenButtonVisibility() { showHiddenBtn.classList.toggle('hidden', hiddenItemIds.size === 0); }
            
            // --- General Event Listeners ---
            addCategoryBtn.addEventListener('click', addCategory); addHeaderBtn.addEventListener('click', addHeaderRow); categoryInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addCategory(); });
            clearFilterBtn.addEventListener('click', () => { noDataEl.querySelector('p').textContent = 'ไม่พบข้อมูล'; activeCategoryName = null; displayData(allRecords); clearFilterBtn.classList.add('hidden'); document.querySelectorAll('#category-list > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500')); });
            showHiddenBtn.addEventListener('click', () => { const itemsToUnhide = (activeCategoryName ? currentRecords : allRecords).map(record => record[itemColumnName]).filter(id => hiddenItemIds.has(id)); if (itemsToUnhide.length > 0) unhideItems(itemsToUnhide); });
            // New Event Listeners
            navProductsBtn.addEventListener('click', () => switchView('products'));
            navRequisitionBtn.addEventListener('click', () => switchView('requisition'));
            navHistoryBtn.addEventListener('click', () => switchView('history'));
            modalOkBtn.addEventListener('click', saveItemSettings);
            modalCancelBtn.addEventListener('click', closeItemSettingsModal);
            autoRequisitionBtn.addEventListener('click', generateRequisition);
            requisitionListBody.addEventListener('click', (e) => { if(e.target.classList.contains('delete-req-btn')) { deleteRequisitionItem(e.target.dataset.id); }});
            confirmRequisitionBtn.addEventListener('click', confirmRequisition);
        });
    </script>

</body>
</html>

