<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลจาก Google Sheet (Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            visibility: hidden; /* ซ่อนเนื้อหาจนกว่าจะตรวจสอบ auth เสร็จ */
        }
        .sortable-ghost {
            background-color: #c0e2ff;
            opacity: 0.7;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        #table-body tr, #category-list > div, #manage-category-list > div {
            cursor: grab;
        }
        
        /* --- Notification Toast Styles (Pill Design) --- */
        #notification-toast {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px); /* เริ่มต้นต่ำลงมาหน่อย */
            backdrop-filter: blur(8px); /* เอฟเฟกต์กระจก */
            min-width: 280px;
            justify-content: center;
            transition: all 0.3s ease-in-out;
            z-index: 9999;
        }
        #notification-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* เลื่อนขึ้นมาตำแหน่งจริง */
        }
        /* สีพื้นหลังแยกตามประเภท */
        .toast-success { background-color: rgba(16, 185, 129, 0.95); color: white; } /* สีเขียว */
        .toast-error { background-color: rgba(239, 68, 68, 0.95); color: white; }   /* สีแดง */
        .toast-info { background-color: rgba(59, 130, 246, 0.95); color: white; }    /* สีฟ้า */

        #category-list::-webkit-scrollbar { height: 4px; }
        #category-list::-webkit-scrollbar-track { background: #f1f1f1; }
        #category-list::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }
        #category-list::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* --- Styles for Focus --- */
        :is(button, [href], input, [tabindex]):focus-visible {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
            border-radius: 2px;
        }
        #table-body td:focus {
            outline: 2px solid #1d4ed8; /* blue-700 */
            outline-offset: -2px;
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* --- CSS สำหรับเส้นตาราง --- */
        .show-grid { border-collapse: collapse; }
        .show-grid th, .show-grid td { border: 1px solid #e5e7eb; /* gray-200 */ }

        /* --- CSS สำหรับ Edit-in-place, Kebab menu และ Context Menu Active --- */
        .kebab-menu {
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .kebab-menu:hover { background-color: #d1d5db; /* gray-300 */ }
        .editing-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            outline: none;
        }
        .menu-item-active {
            background-color: #eff6ff; /* สีฟ้าอ่อน Tailwind blue-50 */
        }
    
        /* --- ดันเนื้อหาลงมาบน desktop เพื่อไม่ให้โดนแทบบาร์บัง --- */
        @media (min-width: 1024px) {
          #app-container {
            margin-top: 40px; /* ปรับตามความสูงจริงของ nav bar */
          }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="fixed top-0 left-0 right-0 z-30 lg: bg-white shadow-md border-b lg:overflow-visible transition-all duration-300 ease-in-out h-14 lg:h-16">
    <div class="container mx-auto lg:w-1/2 h-full relative">
        <div class="border-b border-gray-200">
            <nav class="flex justify-center -mb-px space-x-2" aria-label="Tabs">
                <button id="nav-products" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-blue-600 border-blue-600">รายการสินค้า</button>
                <button id="nav-requisition" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">รายการเบิกของ</button>
                <button id="nav-history" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">ประวัติ</button>
                <button id="nav-manage" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">จัดการ</button>
                <button id="nav-account" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">บัญชี</button>
            </nav>
        </div>
        </div>
</div>

<div class="container mx-auto px-2 py-4 pt-20 sm:p-6 md:p-8 lg:w-1/2 pb-24">
    
    <div id="auth-container" class="mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <form id="login-form">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">เข้าสู่ระบบ</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">เข้าสู่ระบบ</button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <p class="text-sm text-center text-gray-600 mt-4">ยังไม่มีบัญชี? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">สมัครสมาชิกที่นี่</button></p>
            </form>

            <form id="register-form" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">สมัครสมาชิกใหม่</h2>
                 <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                    <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">สมัครสมาชิก</button>
                <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <p class="text-sm text-center text-gray-600 mt-4">มีบัญชีอยู่แล้ว? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">เข้าสู่ระบบที่นี่</button></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="product-list-view">
             <div id="product-search-container" class="mb-4 relative">
                 <input type="text" id="product-search-input" placeholder="ค้นหาสินค้า..." class="w-full p-2 pl-10 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                 </div>
             </div>
        <div id="status-bar-container" class="flex justify-between items-center px-1 mb-2 text-xs text-gray-500">
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        <span>ระบบออนไลน์</span>
    </div>
    <div id="last-update-text" class="flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>รอการอัปเดต...</span>
    </div>
</div>
            <div id="data-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                <div id="loading" class="p-8 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
                </div>
                <div id="error" class="hidden p-8 text-center text-red-600 bg-red-50 rounded-lg">
                    <h3 class="font-bold text-lg">เกิดข้อผิดพลาด</h3>
                    <p id="error-message" class="mt-2">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="data-table" class="hidden w-full min-w-full table-auto show-grid">
                        <thead id="table-head" class="bg-gray-50"></thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="no-data" class="hidden p-8 text-center text-gray-500"><p>ไม่พบข้อมูล</p></div>
            </div>
            <div id="pagination-controls" class="mt-4 flex justify-between items-center"></div>
        </div>

        <div id="requisition-view" class="hidden">
             <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                 <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                     <h2 class="text-2xl font-bold text-gray-700">รายการเบิกของ</h2>
                     <div class="flex items-center gap-2">
                         <button id="auto-requisition-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md">เบิกของอัตโนมัติ</button>
                         <button id="confirm-requisition-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-400">ยืนยัน</button>
                     </div>
                 </div>
                 <div class="overflow-x-auto">
                     <table class="w-full min-w-full divide-y divide-gray-200 show-grid">
                         <thead class="bg-gray-200">
                             <tr>
                                 <th scope="col" class="py-2 px-1 sm:px-2 text-center text-[11px] sm:text-xs font-medium text-gray-600 uppercase w-10">ลำดับ</th>
                                 <th scope="col" class="py-2 px-1 sm:px-2 text-left text-[11px] sm:text-xs font-medium text-gray-600 uppercase w-1/2 sm:w-auto">สินค้า</th>
                                 <th scope="col" class="py-2 px-1 sm:px-2 text-center text-[11px] sm:text-xs font-medium text-gray-600 uppercase">จำนวนเบิก</th>
                                 <th scope="col" class="py-2 px-1 sm:px-2 text-center text-[11px] sm:text-xs font-medium text-gray-600 uppercase">หน่วย</th>
                                 <th scope="col" class="py-2 px-1 sm:px-2 text-center text-[11px] sm:text-xs font-medium text-gray-600 uppercase">จัดการ</th>
                             </tr>
                         </thead>
                         <tbody id="requisition-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                     </table>
                 </div>
             </div>
        </div>

        <div id="history-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">ประวัติการเบิกของ</h2>
                
                <div class="flex flex-col sm:flex-row gap-3 sm:items-end mb-4" id="history-toolbar">
                  <div class="flex gap-2">
                    <input type="date" id="history-date-start" class="border rounded p-2 text-sm">
                    <input type="date" id="history-date-end" class="border rounded p-2 text-sm">
                  </div>
                  <input type="text" id="history-search" placeholder="ค้นหาเลขที่/สินค้า"
                         class="flex-1 border rounded p-2 text-sm">
                  <div class="flex gap-2">
                    <button id="history-export" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded text-sm">ส่งออก CSV</button>
                    <button id="history-print" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">พิมพ์</button>
                  </div>
                </div>

                <div class="overflow-x-auto">
                  <table id="history-table" class="w-full min-w-full table-auto show-grid">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="py-2 px-2 text-left text-xs font-medium text-gray-600 uppercase">เลขที่เบิก</th>
                        <th class="py-2 px-2 text-left text-xs font-medium text-gray-600 uppercase">วันที่</th>
                        <th class="py-2 px-2 text-center text-xs font-medium text-gray-600 uppercase">จำนวนรายการ</th>
                        <th class="py-2 px-2 text-center text-xs font-medium text-gray-600 uppercase">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                  </table>
                </div>

                <div id="history-pagination" class="mt-4 flex justify-between items-center"></div>
                <div id="history-list-container" class="space-y-6" style="display:none"></div>
            </div>
        </div>

        <div id="manage-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 space-y-8">
                <div>
                    <h2 class="text-xl font-bold text-gray-700 mb-4">เพิ่มหมวดหมู่ใหม่</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="category-input" placeholder="ใส่ชื่อหมวดหมู่ที่นี่..." class="flex-grow p-2 border border-gray-300 rounded-md">
                        <button id="add-category-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">เพิ่มหมวดหมู่</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-700 mb-4">จัดการหมวดหมู่ที่มีอยู่</h2>
                    <p class="text-sm text-gray-500 mb-2">ลากเพื่อจัดลำดับ | กด Enter หรือคลิกไอคอน (⋮) เพื่อแก้ไข/ลบ</p>
                    <div id="manage-category-list" class="flex flex-wrap gap-2 items-center"></div>
                </div>
            </div>
        </div>
        
        <div id="account-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">ลงชื่อเข้าใช้ในชื่อ:</p>
                        <p id="user-email" class="font-semibold text-gray-800"></p>
                    </div>
                    <div class="flex items-center gap-2">
                         <button id="app-settings-btn" title="ตั้งค่า" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-blue-600">
                             <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                         </button>
                         <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-gray-400 text-sm"><p>สร้างโดย Gemini</p></footer>
</div>

<div id="category-nav-view" class="hidden fixed bottom-0 left-0 right-0 z-20 bg-white shadow-[0_-2px_10px_-3px_rgba(0,0,0,0.1)] border-t border-gray-200">
    <div class="container mx-auto lg:w-1/2">
        <nav id="category-list" class="flex gap-x-2 px-2 overflow-x-auto" aria-label="Category Tabs"></nav>
    </div>
</div>

<div id="item-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-item-name">ตั้งค่าสินค้า</h3>
            <div class="mt-4 px-7 py-3 space-y-4 text-left">
                <div>
                    <label for="reorder-point" class="block text-sm font-medium text-gray-700">จุดเบิกของ (Reorder Point)</label>
                    <input type="number" id="reorder-point" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="เช่น 10">
                </div>
                <div>
                    <label for="reorder-quantity" class="block text-sm font-medium text-gray-700">จำนวนเบิกอัตโนมัติ</label>
                    <input type="number" id="reorder-quantity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="เช่น 50">
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600">ตกลง</button>
                <button id="modal-cancel-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="category-actions-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="category-modal-name">จัดการหมวดหมู่</h3>
            <div class="mt-6 space-y-3">
                <button id="edit-category-btn" class="w-full px-4 py-3 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                    แก้ไขชื่อหมวดหมู่
                </button>
                <button id="delete-category-btn" class="w-full px-4 py-3 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    ลบหมวดหมู่
                </button>
            </div>
            <div class="mt-6">
                <button id="category-modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="add-header-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">เพิ่มหัวข้อใหม่</h3>
            <div class="mt-4 px-7 py-3">
                <input type="text" id="header-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="ใส่ชื่อหัวข้อที่นี่...">
            </div>
            <div class="items-center px-4 py-3">
                <button id="header-modal-ok-btn" class="px-4 py-2 bg-green-500 text-white rounded-md w-full shadow-sm hover:bg-green-600">เพิ่มหัวข้อ</button>
                <button id="header-modal-cancel-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 rounded-md w-full shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="header-actions-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="header-modal-name">จัดการหัวข้อ</h3>
            <div class="mt-6 space-y-3">
                <button id="edit-header-btn" class="w-full px-4 py-3 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                    แก้ไขหัวข้อ
                </button>
                <button id="delete-header-btn" class="w-full px-4 py-3 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    ลบหัวข้อ
                </button>
            </div>
            <div class="mt-6">
                <button id="header-actions-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="app-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-40">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-xl text-center leading-6 font-medium text-gray-900">ตั้งค่าการเบิกของอัตโนมัติ</h3>
             <div class="mt-4 px-7 py-3 space-y-4 text-left">
                 <div>
                     <label for="setting-trigger-col" class="block text-sm font-medium text-gray-700">คอลัมน์ตรวจสอบสต็อก</label>
                     <input type="text" id="setting-trigger-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                     <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ใช้ตรวจสอบว่าสต็อกถึงจุดที่ต้องเบิกหรือไม่</p>
                 </div>
                  <div>
                     <label for="setting-calc-col" class="block text-sm font-medium text-gray-700">คอลัมน์คำนวณจำนวน</label>
                     <input type="text" id="setting-calc-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                     <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ใช้ในการคำนวณปริมาณเบิก (ถ้ามี)</p>
                 </div>
                  <div>
                     <label for="setting-unit-col" class="block text-sm font-medium text-gray-700">คอลัมน์หน่วยนับ</label>
                     <input type="text" id="setting-unit-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                     <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ระบุหน่วยของสินค้า</p>
                 </div>
             </div>
            <div class="items-center px-4 py-3 sm:flex">
                <button id="app-settings-save-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600">บันทึก</button>
                <button id="app-settings-cancel-btn" class="mt-3 sm:mt-0 sm:ml-3 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="confirm-modal-title">ยืนยันการลบ</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="confirm-modal-body">คุณแน่ใจหรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            </div>
            <div class="items-center px-4 py-3 sm:flex">
                <button id="confirm-modal-ok-btn" class="w-full sm:w-auto px-4 py-2 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600">ยืนยัน</button>
                <button id="confirm-modal-cancel-btn" class="mt-3 sm:mt-0 sm:ml-3 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 rounded-md shadow-sm hover:bg-gray-300">ยกเลิก</button>
            </div>
        </div>
    </div>
</div>

<div id="quantity-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-40">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="quantity-modal-name">ระบุจำนวน</h3>
            <div class="mt-4 px-7 py-3 flex justify-center">
                <div class="flex items-center justify-center">
                    <button class="quantity-modal-change-btn h-10 w-10 rounded-l-md border bg-gray-200 text-gray-600 hover:bg-gray-300 text-lg" data-amount="-1">-</button>
                    <span id="quantity-display" class="h-10 w-20 text-center border-t border-b bg-white text-lg flex items-center justify-center">1</span>
                    <button class="quantity-modal-change-btn h-10 w-10 rounded-r-md border bg-gray-200 text-gray-600 hover:bg-gray-300 text-lg" data-amount="1">+</button>
                </div>
            </div>
            <div class="items-center px-4 py-3 sm:flex">
                <button id="quantity-modal-ok-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600">
                    ตกลง
                </button>
                <button id="quantity-modal-cancel-btn" class="mt-3 sm:mt-0 sm:ml-3 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="notification-toast" class="hidden fixed z-50 flex items-center gap-2 px-6 py-3 rounded-full shadow-lg transition-all duration-300 transform translate-y-full opacity-0">
    <span id="notification-icon"></span>
    <p id="notification-message" class="text-sm font-medium"></p>
</div>

<div id="item-context-menu" class="hidden fixed z-40 bg-white shadow-lg rounded-md ring-1 ring-black ring-opacity-5 focus:outline-none w-48">
    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
        <button id="context-menu-settings" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span>ตั้งค่าสินค้า</span>
        </button>
        <button id="context-menu-hide" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-2.14 2.14" /></svg>
            <span>ซ่อนแถวสินค้า</span>
        </button>
        <div class="border-t border-gray-100 my-1"></div>
        <button id="context-menu-requisition" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>เบิกของ (Manual)</span>
        </button>
        <div class="border-t border-gray-100 my-1"></div>
        <button id="context-menu-add-header" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z"></path></svg>
            <span>เพิ่มหัวข้อใหม่</span>
        </button>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDocs, setDoc, getDoc, Timestamp, writeBatch, runTransaction, arrayUnion, arrayRemove, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    document.addEventListener('DOMContentLoaded', () => {
        const sheetUrl = 'https://script.google.com/macros/s/AKfycbzQe5C0BtWNYNS-cM9hr_twfw7Epb1ptkVpdn1L3sHIsctY9ImeO5Vsls0MUVGV6Tox7A/exec';

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container'), appContainer = document.getElementById('app-container'), loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form'), loginEmailInput = document.getElementById('login-email'), loginPasswordInput = document.getElementById('login-password'), registerEmailInput = document.getElementById('register-email'), registerPasswordInput = document.getElementById('register-password'), loginErrorEl = document.getElementById('login-error'), registerErrorEl = document.getElementById('register-error'), showRegisterBtn = document.getElementById('show-register-btn'), showLoginBtn = document.getElementById('show-login-btn'), userEmailEl = document.getElementById('user-email'), logoutBtn = document.getElementById('logout-btn'), loadingEl = document.getElementById('loading'), errorEl = document.getElementById('error'), errorMessageEl = document.getElementById('error-message'), noDataEl = document.getElementById('no-data'), tableEl = document.getElementById('data-table'), tableHead = document.getElementById('table-head'), tableBody = document.getElementById('table-body'), categoryInput = document.getElementById('category-input'), addCategoryBtn = document.getElementById('add-category-btn'), categoryList = document.getElementById('category-list'), manageCategoryList = document.getElementById('manage-category-list'), navProductsBtn = document.getElementById('nav-products'), navRequisitionBtn = document.getElementById('nav-requisition'), navHistoryBtn = document.getElementById('nav-history'), navManageBtn = document.getElementById('nav-manage'), navAccountBtn = document.getElementById('nav-account'), productListView = document.getElementById('product-list-view'), requisitionView = document.getElementById('requisition-view'), historyView = document.getElementById('history-view'), manageView = document.getElementById('manage-view'), accountView = document.getElementById('account-view'), categoryNavView = document.getElementById('category-nav-view'), autoRequisitionBtn = document.getElementById('auto-requisition-btn'), requisitionListBody = document.getElementById('requisition-list-body'), confirmRequisitionBtn = document.getElementById('confirm-requisition-btn'), historyListContainer = document.getElementById('history-list-container'), itemSettingsModal = document.getElementById('item-settings-modal'), modalItemName = document.getElementById('modal-item-name'), reorderPointInput = document.getElementById('reorder-point'), reorderQuantityInput = document.getElementById('reorder-quantity'), modalOkBtn = document.getElementById('modal-ok-btn'), modalCancelBtn = document.getElementById('modal-cancel-btn'), categoryActionsModal = document.getElementById('category-actions-modal'), categoryModalName = document.getElementById('category-modal-name'), editCategoryBtn = document.getElementById('edit-category-btn'), deleteCategoryBtn = document.getElementById('delete-category-btn'), categoryModalCancelBtn = document.getElementById('category-modal-cancel-btn'), addHeaderModal = document.getElementById('add-header-modal'), headerInput = document.getElementById('header-input'), headerModalOkBtn = document.getElementById('header-modal-ok-btn'), headerModalCancelBtn = document.getElementById('header-modal-cancel-btn'), headerActionsModal = document.getElementById('header-actions-modal'), headerModalName = document.getElementById('header-modal-name'), editHeaderBtn = document.getElementById('edit-header-btn'), deleteHeaderBtn = document.getElementById('delete-header-btn'), headerActionsCancelBtn = document.getElementById('header-actions-cancel-btn'), confirmModal = document.getElementById('confirm-modal'), confirmModalTitle = document.getElementById('confirm-modal-title'), confirmModalBody = document.getElementById('confirm-modal-body'), confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn'), confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn'), appSettingsModal = document.getElementById('app-settings-modal'), appSettingsBtn = document.getElementById('app-settings-btn'), appSettingsSaveBtn = document.getElementById('app-settings-save-btn'), appSettingsCancelBtn = document.getElementById('app-settings-cancel-btn'), settingTriggerColInput = document.getElementById('setting-trigger-col'), settingCalcColInput = document.getElementById('setting-calc-col'), settingUnitColInput = document.getElementById('setting-unit-col'), notificationToast = document.getElementById('notification-toast'), notificationMessage = document.getElementById('notification-message'), itemContextMenu = document.getElementById('item-context-menu'), contextMenuSettingsBtn = document.getElementById('context-menu-settings'), contextMenuHideBtn = document.getElementById('context-menu-hide'), contextMenuAddHeaderBtn = document.getElementById('context-menu-add-header'), paginationControls = document.getElementById('pagination-controls'), productSearchContainer = document.getElementById('product-search-container'), productSearchInput = document.getElementById('product-search-input'), quantityModal = document.getElementById('quantity-modal'), quantityModalName = document.getElementById('quantity-modal-name'), quantityDisplay = document.getElementById('quantity-display'), quantityModalOkBtn = document.getElementById('quantity-modal-ok-btn'), quantityModalCancelBtn = document.getElementById('quantity-modal-cancel-btn');
        // --- NEW: Constants Object ---
        const CONSTANTS = {
            FIRESTORE_PATHS: { CATEGORIES: 'categories', HIDDEN_ITEMS: 'hiddenItemsByCategory', SORT_ORDERS: 'sortOrders', CUSTOM_ROWS: 'customRows', CATEGORY_ORDER: 'categoryOrder', ITEM_SETTINGS: 'itemSettings', REQUISITION_LIST: 'requisitionList', REQUISITION_HISTORY: 'requisitionHistory', COUNTERS: 'counters', APP_SETTINGS: 'appSettings' },
            SHEET_COLUMN_NAMES: { TRIGGER_STOCK: "รักษ์ยา", CALCULATION_STOCK: "เบบี้ช็อป", UNIT: "หน่วย" },
            SORT_KEY_GLOBAL: '__global__',
            ITEMS_PER_PAGE: 50,
        };

        // --- NEW: Centralized App State ---
        const appState = {
    allRecords: [], 
    
    // --- เพิ่มบรรทัดนี้เข้าไปครับ ---
    hasPendingUpdate: false, 
    // ---------------------------

    allRecordsMap: new Map(), 
    currentFilteredRecords: [], 
    categories: [], 
    sortOrdersMap: {}, 
    categoryOrder: [], 
    customRows: new Map(), 
    itemSettings: new Map(), 
    requisitionList: [], 
    historyList: [], 
    hiddenItemsMap: {}, 
    activeCategoryName: null, 
    currentEditingItemId: null, 
    currentEditingCategory: null, 
    currentEditingHeaderId: null, 
    currentEditingHeaderText: null, 
    confirmCallback: null, 
    notificationTimeout: null, 
    insertHeaderAboveId: null, 
    contextMenuItemRecord: null, 
    sortableInstance: null, 
    categorySortableInstance: null,
    appSettings: { 
        triggerStockColumnName: CONSTANTS.SHEET_COLUMN_NAMES.TRIGGER_STOCK, 
        calculationStockColumnName: CONSTANTS.SHEET_COLUMN_NAMES.CALCULATION_STOCK, 
        unitColumnName: CONSTANTS.SHEET_COLUMN_NAMES.UNIT 
    },
    userId: null, 
    unsubscribes: [], 
    currentPage: 1, 
    initialDataLoaded: false, 
    categoriesFirstLoad: true, 
    resolveCategoriesLoaded: null, 
    itemForRequisition: null,
};
        const categoriesLoadedPromise = new Promise(resolve => { appState.resolveCategoriesLoaded = resolve; });
        // --- NEW: Double Tap Tracker ---
        let lastTap = { time: 0, id: null };
        // Firebase Refs
        let categoriesCollectionRef, hiddenItemsDocRef, sortOrdersDocRef, customRowsCollectionRef, categoryOrderDocRef, itemSettingsCollectionRef, requisitionListCollectionRef, requisitionHistoryCollectionRef, countersDocRef, appSettingsDocRef;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY", authDomain: "pos-6-23035.firebaseapp.com", projectId: "pos-6-23035", storageBucket: "pos-6-23035.appspot.com", messagingSenderId: "1025982856125", appId: "1:1025982856125:web:28e47483570949900f30d4" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                appState.userId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.querySelectorAll('#user-email').forEach(el => el.textContent = user.email);
                initializeListeners(appState.userId);
                switchView('products');
                if(!appState.initialDataLoaded) fetchAllDataFromSheet(); 
                
                // --- NEW: Start polling for sheet updates ---
                startSheetPolling();

            } else {
                appState.userId = null;
                appState.initialDataLoaded = false;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appState.unsubscribes.forEach(unsub => unsub && unsub());
                appState.unsubscribes = [];
                Object.assign(appState, { allRecords: [], allRecordsMap: new Map(), categories: [], hiddenItemsMap: {}, sortOrdersMap: {}, categoryOrder: [], customRows: new Map(), itemSettings: new Map(), requisitionList: [], historyList: [] });
                displayCategories(); 
            }
            document.body.style.visibility = 'visible';
            // --- Fallback เผื่อ Firebase ไม่ตอบ ---
            setTimeout(() => { if(document.body.style.visibility === 'hidden') document.body.style.visibility = 'visible'; }, 5000);
        });
        
        function initializeListeners(currentUserId) {
            if (!currentUserId) return;
            appState.unsubscribes.forEach(unsub => unsub && unsub());
            appState.unsubscribes = [];
            const userPath = `artifacts/${appId}/users/${currentUserId}`;
            
            categoriesCollectionRef = collection(db, `${userPath}/${CONSTANTS.FIRESTORE_PATHS.CATEGORIES}`);
            hiddenItemsDocRef = doc(db, `${userPath}/settings`, CONSTANTS.FIRESTORE_PATHS.HIDDEN_ITEMS);
            sortOrdersDocRef = doc(db, `${userPath}/settings`, CONSTANTS.FIRESTORE_PATHS.SORT_ORDERS);
            customRowsCollectionRef = collection(db, `${userPath}/${CONSTANTS.FIRESTORE_PATHS.CUSTOM_ROWS}`);
            categoryOrderDocRef = doc(db, `${userPath}/settings`, CONSTANTS.FIRESTORE_PATHS.CATEGORY_ORDER);
            itemSettingsCollectionRef = collection(db, `${userPath}/${CONSTANTS.FIRESTORE_PATHS.ITEM_SETTINGS}`);
            requisitionListCollectionRef = collection(db, `${userPath}/${CONSTANTS.FIRESTORE_PATHS.REQUISITION_LIST}`);
            requisitionHistoryCollectionRef = collection(db, `${userPath}/${CONSTANTS.FIRESTORE_PATHS.REQUISITION_HISTORY}`);
            countersDocRef = doc(db, `${userPath}/settings`, CONSTANTS.FIRESTORE_PATHS.COUNTERS);
            appSettingsDocRef = doc(db, `${userPath}/settings`, CONSTANTS.FIRESTORE_PATHS.APP_SETTINGS);

            appState.unsubscribes.push(onSnapshot(categoriesCollectionRef, (snap) => { appState.categories = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); displayCategories(); if (appState.categoriesFirstLoad && appState.resolveCategoriesLoaded) { appState.categoriesFirstLoad = false; appState.resolveCategoriesLoaded(); } }, (err) => showError("โหลดหมวดหมู่ไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(hiddenItemsDocRef, (docSnap) => { const data = docSnap.exists() ? docSnap.data() : {}; appState.hiddenItemsMap = {}; for (const categoryName in data) { if (Array.isArray(data[categoryName])) { appState.hiddenItemsMap[categoryName] = new Set(data[categoryName]); } } if (appState.allRecords.length > 0) { displayData(); } }, (err) => showError("โหลดรายการที่ซ่อนไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(sortOrdersDocRef, (snap) => { appState.sortOrdersMap = (snap.exists() && snap.data().orders) ? snap.data().orders : {}; if (appState.allRecords.length > 0) displayData(); }, (err) => showError("โหลดลำดับจัดเรียงไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(categoryOrderDocRef, (snap) => { appState.categoryOrder = (snap.exists() && snap.data().order) ? snap.data().order : []; if (appState.categories.length > 0) displayCategories(); }, (err) => showError("โหลดลำดับหมวดหมู่ไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(customRowsCollectionRef, (snap) => { appState.customRows.clear(); snap.docs.forEach(doc => appState.customRows.set(doc.id, doc.data())); if (appState.allRecords.length > 0) displayData(); }, (err) => showError("โหลดหัวข้อไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(itemSettingsCollectionRef, (snap) => { appState.itemSettings.clear(); snap.docs.forEach(doc => appState.itemSettings.set(doc.id, doc.data())); }, (err) => showError("โหลดการตั้งค่าสินค้าไม่สำเร็จ: " + err.message)));
            
            // --- Updated Requisition Snapshot for Notifications ---
            let isFirstRequisitionLoad = true;
            appState.unsubscribes.push(onSnapshot(requisitionListCollectionRef, (snap) => {
                appState.requisitionList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayRequisitionList();
                if (!isFirstRequisitionLoad) {
                    if (!snap.metadata.hasPendingWrites) {
                        showNotification('รายการเบิกของมีการอัปเดต', 'info');
                    }
                }
                isFirstRequisitionLoad = false;
            }, (err) => showError("โหลดรายการเบิกของไม่สำเร็จ: " + err.message)));

            appState.unsubscribes.push(onSnapshot(requisitionHistoryCollectionRef, (snap) => { appState.historyList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds); displayHistory(); }, (err) => showError("โหลดประวัติไม่สำเร็จ: " + err.message)));
            appState.unsubscribes.push(onSnapshot(appSettingsDocRef, (snap) => { if (snap.exists()) { appState.appSettings = { ...appState.appSettings, ...snap.data() }; } updateAppSettingsModalInputs(); }, (err) => showError("โหลดการตั้งค่าแอปไม่สำเร็จ: " + err.message)));
        }

        showRegisterBtn?.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        showLoginBtn?.addEventListener('click', () => { registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        loginForm?.addEventListener('submit', async (e) => { e.preventDefault(); loginErrorEl.textContent = ''; try { await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value); } catch (error) { loginErrorEl.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง"; } });
        registerForm?.addEventListener('submit', async (e) => { e.preventDefault(); registerErrorEl.textContent = ''; try { await createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value); } catch (error) { if (error.code === 'auth/weak-password') registerErrorEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร'; else if (error.code === 'auth/email-already-in-use') registerErrorEl.textContent = 'อีเมลนี้ถูกใช้งานแล้ว'; else registerErrorEl.textContent = 'เกิดข้อผิดพลาดในการสมัคร'; } });
        logoutBtn?.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); } });

async function saveCurrentSortOrder(newVisibleOrder) {
            if (!sortOrdersDocRef) return;
            const key = appState.activeCategoryName || CONSTANTS.SORT_KEY_GLOBAL;
            
            try {
                // 1. ดึงลำดับทั้งหมดที่มีอยู่เดิม (จาก State เพื่อความเร็ว)
                let currentFullOrder = appState.sortOrdersMap[key] || [];
                
                // แปลงทุกอย่างเป็น String และ Trim เพื่อป้องกันความผิดพลาดเรื่อง Type
                currentFullOrder = currentFullOrder.map(id => String(id).trim());
                const newVisibleIds = newVisibleOrder.map(id => String(id).trim());
                const newVisibleSet = new Set(newVisibleIds);

                // 2. สร้างรายการใหม่โดยเอา item ที่กำลังจัดเรียงอยู่ (newVisibleOrder) ออกจาก list เดิมชั่วคราว
                const preservedItems = [];
                let firstMatchIndex = -1;

                for (let i = 0; i < currentFullOrder.length; i++) {
                    const id = currentFullOrder[i];
                    if (newVisibleSet.has(id)) {
                        // เจอ item ที่เรากำลังจัดเรียง ให้จำตำแหน่งแรกที่เจอไว้
                        if (firstMatchIndex === -1) {
                            firstMatchIndex = preservedItems.length;
                        }
                        // ไม่ต้อง push เข้า preservedItems (เพราะเราจะแทรกชุดใหม่เข้าไปทีเดียว)
                    } else {
                        preservedItems.push(id);
                    }
                }

                // กรณีเป็นสินค้าใหม่ที่ไม่เคยมีในลำดับมาก่อน ให้ต่อท้าย
                if (firstMatchIndex === -1) {
                    firstMatchIndex = preservedItems.length;
                }

                // 3. แทรกรายการที่จัดเรียงใหม่ เข้าไปในตำแหน่งเดิม
                const finalOrder = [
                    ...preservedItems.slice(0, firstMatchIndex),
                    ...newVisibleIds,
                    ...preservedItems.slice(firstMatchIndex)
                ];

                // 4. อัปเดต State ทันทีเพื่อให้หน้าจอไม่กระตุกหากมีการ render ซ้ำ
                appState.sortOrdersMap[key] = finalOrder;

                // 5. บันทึกลง Firebase (ดึงข้อมูลล่าสุดจาก DB ก่อนกันพลาดกรณีเปิดหลายเครื่อง)
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(sortOrdersDocRef);
                    const serverOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {};
                    
                    // ทำ Logic เดียวกันกับข้อมูล Server (Merge Logic)
                    let serverFullOrder = serverOrders[key] || [];
                    serverFullOrder = serverFullOrder.map(id => String(id).trim());
                    
                    const serverPreserved = [];
                    let serverInsertIdx = -1;
                    
                    for (let i = 0; i < serverFullOrder.length; i++) {
                        const id = serverFullOrder[i];
                        if (newVisibleSet.has(id)) {
                            if (serverInsertIdx === -1) serverInsertIdx = serverPreserved.length;
                        } else {
                            serverPreserved.push(id);
                        }
                    }
                    if (serverInsertIdx === -1) serverInsertIdx = serverPreserved.length;

                    const serverFinalOrder = [
                        ...serverPreserved.slice(0, serverInsertIdx),
                        ...newVisibleIds,
                        ...serverPreserved.slice(serverInsertIdx)
                    ];

                    serverOrders[key] = serverFinalOrder;
                    transaction.set(sortOrdersDocRef, { orders: serverOrders });
                });

            } catch (error) {
                console.error("Save sort order failed:", error);
                showError("บันทึกการจัดเรียงไม่สำเร็จ: " + error.message);
            }
        }
        
        async function saveCategoryOrder(newOrder) { if (!categoryOrderDocRef) return;
        try { await setDoc(categoryOrderDocRef, { order: newOrder }); } catch (error) { showError("บันทึกการจัดเรียงหมวดหมู่ไม่สำเร็จ: " + error.message);
        } }
        async function hideItem(itemId, itemName) { if (!hiddenItemsDocRef || !itemId) return;
        const categoryKey = appState.activeCategoryName || CONSTANTS.SORT_KEY_GLOBAL; try { await updateDoc(hiddenItemsDocRef, { [categoryKey]: arrayUnion(itemId) }); showNotification(`ซ่อน '${itemName}' แล้ว`, false);
        } catch (e) { if (e.code === 'not-found') { try { await setDoc(hiddenItemsDocRef, { [categoryKey]: [itemId] });
        showNotification(`ซ่อน '${itemName}' แล้ว`, false); } catch (setErr) { showError("ซ่อนรายการไม่สำเร็จ: " + setErr.message); } } else { showError("ซ่อนรายการไม่สำเร็จ: " + e.message);
        } } }
        async function addCategory() { if (!categoriesCollectionRef) return;
        const name = categoryInput.value.trim(); if (name && !appState.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { try { await addDoc(categoriesCollectionRef, { name });
        categoryInput.value = ''; showNotification(`เพิ่มหมวดหมู่ '${name}' สำเร็จ`, false); } catch(error) { showError("เพิ่มหมวดหมู่ไม่สำเร็จ: " + error.message);
        } } else if (name) showNotification(`มีหมวดหมู่ '${name}' อยู่แล้ว`); }
        async function updateCategoryName(id, oldName, newName) { const trimmedNewName = newName.trim();
        if (!trimmedNewName || trimmedNewName === oldName) return; if (appState.categories.some(c => c.name.toLowerCase() === trimmedNewName.toLowerCase() && c.id !== id)) { showNotification(`มีหมวดหมู่ '${trimmedNewName}' อยู่แล้ว`);
        return; } try { await runTransaction(db, async (transaction) => { const sortOrdersSnap = await transaction.get(sortOrdersDocRef); if (sortOrdersSnap.exists()) { const currentSortOrders = sortOrdersSnap.data().orders || {}; if (Object.prototype.hasOwnProperty.call(currentSortOrders, oldName)) { currentSortOrders[trimmedNewName] = currentSortOrders[oldName]; delete currentSortOrders[oldName]; transaction.set(sortOrdersDocRef, { orders: currentSortOrders }); } } const hiddenItemsSnap = await transaction.get(hiddenItemsDocRef); if (hiddenItemsSnap.exists()) { const currentHiddenItems = hiddenItemsSnap.data(); if (Object.prototype.hasOwnProperty.call(currentHiddenItems, oldName)) { currentHiddenItems[trimmedNewName] = currentHiddenItems[oldName]; delete currentHiddenItems[oldName]; transaction.set(hiddenItemsDocRef, currentHiddenItems); } } const customRowsQuery = query(customRowsCollectionRef, where("categoryName", "==", oldName)); const customRowsSnap = await getDocs(customRowsQuery); customRowsSnap.forEach(docSnap => { transaction.update(docSnap.ref, { categoryName: trimmedNewName });
        }); const categoryDocRef = doc(categoriesCollectionRef, id); transaction.update(categoryDocRef, { name: trimmedNewName }); }); showNotification(`แก้ไขหมวดหมู่เป็น '${trimmedNewName}' สำเร็จ`, false);
        } catch (error) { console.error("Transaction for editing category failed: ", error); showError("แก้ไขหมวดหมู่ไม่สำเร็จ: " + error.message);
        } }
        async function deleteCategory(id, name) { if (!categoriesCollectionRef) return;
        try { await deleteDoc(doc(categoriesCollectionRef, id)); showNotification(`ลบหมวดหมู่ '${name}' แล้ว`, false); displayData(); } catch(error) { showError("ลบหมวดหมู่ไม่สำเร็จ: " + error.message);
        } }
        async function addHeaderRow(headerText) { if (!headerText || !headerText.trim()) return;
        try { const key = appState.activeCategoryName || CONSTANTS.SORT_KEY_GLOBAL; const newDocRef = await addDoc(customRowsCollectionRef, { text: headerText.trim(), categoryName: appState.activeCategoryName });
        const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {}; let currentCategoryOrder = currentOrders[key] ||
        []; const newHeaderId = newDocRef.id; if (appState.insertHeaderAboveId) { const insertIndex = currentCategoryOrder.indexOf(appState.insertHeaderAboveId); if (insertIndex !== -1) { currentCategoryOrder.splice(insertIndex, 0, newHeaderId);
        } else { currentCategoryOrder.unshift(newHeaderId); } } else { currentCategoryOrder.unshift(newHeaderId); } currentOrders[key] = currentCategoryOrder; await setDoc(sortOrdersDocRef, { orders: currentOrders });
        showNotification(`เพิ่มหัวข้อ '${headerText}' สำเร็จ`, false); } catch (error) { showError("เพิ่มหัวข้อไม่สำเร็จ: " + error.message);
        } }
        async function editHeaderRow(id, newText) { const trimmedText = newText.trim();
        if(trimmedText) { try { await updateDoc(doc(customRowsCollectionRef, id), { text: trimmedText }); showNotification('แก้ไขหัวข้อสำเร็จ', false);
        } catch (error) { showError("แก้ไขหัวข้อไม่สำเร็จ: " + error.message); } } }
        async function deleteHeaderRow(id, text) { if (!customRowsCollectionRef || !sortOrdersDocRef) return;
        try { const key = appState.activeCategoryName || CONSTANTS.SORT_KEY_GLOBAL; const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ?
        docSnap.data().orders : {}; const currentCategoryOrder = currentOrders[key] || []; currentOrders[key] = currentCategoryOrder.filter(itemId => itemId !== id);
        await setDoc(sortOrdersDocRef, { orders: currentOrders }); await deleteDoc(doc(customRowsCollectionRef, id)); showNotification(`ลบหัวข้อ '${text}' แล้ว`, false);
        } catch (error) { showError("ลบหัวข้อไม่สำเร็จ: " + error.message); } }
        async function saveItemSettings() { if (!itemSettingsCollectionRef || !appState.currentEditingItemId) return;
        const point = parseInt(reorderPointInput.value, 10); const quantity = parseInt(reorderQuantityInput.value, 10); const settings = { reorderPoint: isNaN(point) ?
        null : point, reorderQuantity: isNaN(quantity) ? null : quantity }; try { await setDoc(doc(itemSettingsCollectionRef, appState.currentEditingItemId), settings); showNotification(`บันทึกการตั้งค่า '${appState.currentEditingItemId}' แล้ว`, false);
        closeItemSettingsModal(); } catch(error) { showError("บันทึกการตั้งค่าไม่สำเร็จ: " + error.message); } }
        async function saveAppSettings() { if (!appSettingsDocRef) return;
        const newSettings = { triggerStockColumnName: settingTriggerColInput.value.trim() || CONSTANTS.SHEET_COLUMN_NAMES.TRIGGER_STOCK, calculationStockColumnName: settingCalcColInput.value.trim() || CONSTANTS.SHEET_COLUMN_NAMES.CALCULATION_STOCK, unitColumnName: settingUnitColInput.value.trim() || CONSTANTS.SHEET_COLUMN_NAMES.UNIT, };
        try { await setDoc(appSettingsDocRef, newSettings, { merge: true }); showNotification('บันทึกการตั้งค่าแล้ว', false); closeAppSettingsModal(); } catch (error) { showError("บันทึกการตั้งค่าไม่สำเร็จ: " + error.message);
        } }
        async function generateAutoRequisition() { if (appState.allRecords.length === 0) { showNotification('ยังไม่มีข้อมูลสินค้าหรือการตั้งค่า'); return;
        } const firstRecordKeys = Object.keys(appState.allRecords[0]); if (!firstRecordKeys.includes(appState.appSettings.triggerStockColumnName) || !firstRecordKeys.includes(appState.appSettings.calculationStockColumnName)) { showError(`ไม่พบคอลัมน์: "${appState.appSettings.triggerStockColumnName}" หรือ "${appState.appSettings.calculationStockColumnName}" ใน Google Sheet กรุณาตรวจสอบการตั้งค่า`); return;
        } const itemColumnName = Object.keys(appState.allRecords[0])[0] || ''; const itemsToRequisition = [];
        appState.allRecords.forEach(record => { const itemId = record[itemColumnName]; const settings = appState.itemSettings.get(itemId); if (settings && typeof settings.reorderPoint === 'number' && typeof settings.reorderQuantity === 'number') { const triggerStock = parseInt(record[appState.appSettings.triggerStockColumnName] || 0, 10); if (!isNaN(triggerStock) && triggerStock <= settings.reorderPoint) { const calculationStock = parseInt(record[appState.appSettings.calculationStockColumnName], 10); if (!isNaN(calculationStock) && calculationStock > 2) { let finalQuantity = settings.reorderQuantity; const halfCalcStock = 0.5 * calculationStock; if (settings.reorderQuantity > halfCalcStock) { const halfAutoQty = 0.5 * settings.reorderQuantity; finalQuantity = Math.min(halfAutoQty, halfCalcStock); } const roundedQuantity = Math.floor(finalQuantity); if (roundedQuantity > 0) { itemsToRequisition.push({ id: itemId, name: record[itemColumnName], quantity: roundedQuantity, unit: record[appState.appSettings.unitColumnName] ||
        'ชิ้น' }); } } } } }); if (itemsToRequisition.length === 0) { showNotification('ไม่พบสินค้าที่ถึงจุดเบิกของตามเงื่อนไข'); return;
        } try { const batch = writeBatch(db); itemsToRequisition.forEach(item => { const docRef = doc(requisitionListCollectionRef, item.id); batch.set(docRef, { name: item.name, quantity: item.quantity, unit: item.unit }); });
        await batch.commit(); showNotification(`เพิ่ม ${itemsToRequisition.length} รายการในรายการเบิกของสำเร็จ!`, false); switchView('requisition'); } catch (error) { showError("สร้างรายการเบิกอัตโนมัติไม่สำเร็จ: " + error.message);
        } }
        async function updateRequisitionQuantity(id, newQuantity) { if (!requisitionListCollectionRef || !id) return;
        const quantity = parseInt(newQuantity, 10); if (isNaN(quantity) || quantity < 1) { showNotification('จำนวนต้องเป็นตัวเลขมากกว่า 0', true); const display = requisitionListBody.querySelector(`span[data-id="${id}"]`);
        const originalItem = appState.requisitionList.find(item => item.id === id); if (display && originalItem) { display.textContent = originalItem.quantity; } return;
        } try { const docRef = doc(requisitionListCollectionRef, id); await updateDoc(docRef, { quantity: quantity });
        } catch (error) { showError("แก้ไขจำนวนเบิกไม่สำเร็จ: " + error.message); } }
        async function deleteRequisitionItem(id, name) { if(!requisitionListCollectionRef) return;
        try { await deleteDoc(doc(requisitionListCollectionRef, id)); showNotification(`ลบ '${name}' ออกจากรายการเบิกแล้ว`, false); } catch (error) { showError("ลบรายการเบิกไม่สำเร็จ: " + error.message);
        } }
        async function confirmRequisition() {
  try {
    if (!requisitionListCollectionRef || !appState || !Array.isArray(appState.requisitionList) || appState.requisitionList.length === 0) return;
    const totalItems = appState.requisitionList.length;
    const totalQty = appState.requisitionList.reduce((s, it) => s + (parseInt(it.quantity, 10) || 0), 0);
    return runTransaction(db, async (transaction) => {
      const counterSnap = await transaction.get(countersDocRef);
      const currentCounter = counterSnap.exists() ? (counterSnap.data().requisitionNumber || 0) : 0;
      const newCounter = currentCounter + 1;
      const now = new Date();
      const generatedReqNumber = `REQ-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}-${String(newCounter).padStart(4,'0')}`;
      const historyDocRef = doc(requisitionHistoryCollectionRef);
      transaction.set(historyDocRef, {
        requisitionNumber: generatedReqNumber,
        timestamp: (typeof Timestamp !== 'undefined' && Timestamp.now) 
? Timestamp.now() : new Date(),
        items: appState.requisitionList.map(({ id, ...rest }) => rest),
        totalItems,
        totalQty
      });
      appState.requisitionList.forEach(item => transaction.delete(doc(requisitionListCollectionRef, item.id)));
      transaction.set(countersDocRef, { requisitionNumber: newCounter }, { merge: true });
if (typeof showNotification === 'function') showNotification(`ยืนยันการเบิกของ ${generatedReqNumber} เรียบร้อย`, false);
      return generatedReqNumber;
    });
} catch (error) {
    console.error("Transaction failed: ", error);
    if (typeof showError === 'function') showError("ยืนยันการเบิกของไม่สำเร็จ: " + error.message);
}
}
        async function addManualRequisition(item, quantity) { if (!requisitionListCollectionRef || !item || !quantity || quantity < 1) return;
        const itemColumnName = Object.keys(appState.allRecords[0])[0]; const unitColumnName = appState.appSettings.unitColumnName; const itemId = item[itemColumnName]; const itemName = item[itemColumnName];
        const itemUnit = item[unitColumnName] || 'ชิ้น'; try { const docRef = doc(requisitionListCollectionRef, itemId);
        await setDoc(docRef, { name: itemName, quantity: quantity, unit: itemUnit }, { merge: true }); showNotification(`เพิ่ม/อัปเดต '${itemName}' จำนวน ${quantity} ${itemUnit}`, false);
        } catch (error) { showError("เพิ่มรายการเบิกไม่สำเร็จ: " + error.message); } }

        function displayCategories() {
            if (appState.categorySortableInstance) appState.categorySortableInstance.destroy();
            categoryList.innerHTML = ''; manageCategoryList.innerHTML = '';
            if (!appState.userId) return;

            const navFragment = document.createDocumentFragment();
            const manageFragment = document.createDocumentFragment();
            const allBtn = document.createElement('button');
            allBtn.dataset.id = 'all';
            allBtn.className = 'whitespace-nowrap py-4 px-2 font-bold text-sm focus:outline-none';
            allBtn.textContent = 'ทั้งหมด';
            allBtn?.addEventListener('click', () => { appState.currentPage = 1; noDataEl.querySelector('p').textContent = 'ไม่พบสินค้า'; productSearchContainer.classList.remove('hidden'); productSearchInput.value = ''; appState.activeCategoryName = 'ทั้งหมด'; appState.currentFilteredRecords = [...appState.allRecords]; displayData(); document.querySelectorAll('#category-list button').forEach(btn => { btn.classList.remove('text-blue-600'); btn.classList.add('text-gray-500', 'hover:text-gray-700'); }); allBtn.classList.add('text-blue-600'); allBtn.classList.remove('text-gray-500', 'hover:text-gray-700'); });
            navFragment.appendChild(allBtn);

            const sortedCategories = [...appState.categories].sort((a, b) => { const indexA = appState.categoryOrder.indexOf(a.id); const indexB = appState.categoryOrder.indexOf(b.id); if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name, 'th'); if (indexA === -1) return 1; if (indexB === -1) return -1; return indexA - indexB; });
            if (appState.categories.length === 0) { manageCategoryList.innerHTML = '<p class="text-gray-500 text-sm">ยังไม่มีหมวดหมู่</p>';}
            else { allBtn.classList.add('text-blue-600');
            }
            if (appState.activeCategoryName === null && appState.categories.length > 0) { appState.activeCategoryName = 'ทั้งหมด';
            }
            
            sortedCategories.forEach((category) => {
                const categoryBtn = document.createElement('button');
                categoryBtn.dataset.id = category.id;
                categoryBtn.className = 'whitespace-nowrap py-4 px-2 font-bold text-sm focus:outline-none';
                categoryBtn.classList.toggle('text-blue-600', appState.activeCategoryName === category.name || appState.activeCategoryName === category.id);
                categoryBtn.classList.toggle('text-gray-500', appState.activeCategoryName !== category.name);
                categoryBtn.classList.toggle('hover:text-gray-700', appState.activeCategoryName !== category.name);
                categoryBtn.textContent = category.name;
                categoryBtn?.addEventListener('click', () => { const 
itemColumnName = appState.allRecords.length > 0 ? Object.keys(appState.allRecords[0])[0] : ''; if (!itemColumnName) return; appState.currentPage = 
1; productSearchContainer.classList.add('hidden'); productSearchInput.value = '';
                appState.currentFilteredRecords = appState.allRecords.filter(r => r[itemColumnName]?.toLowerCase().includes(category.name.toLowerCase())); noDataEl.querySelector('p').textContent = `ไม่พบสินค้าในหมวดหมู่ "${category.name}"`; appState.activeCategoryName = category.name; displayData();
                document.querySelectorAll('#category-list button').forEach(btn => { btn.classList.remove('text-blue-600'); btn.classList.add('text-gray-500', 'hover:text-gray-700'); }); categoryBtn.classList.add('text-blue-600'); categoryBtn.classList.remove('text-gray-500', 'hover:text-gray-700'); });
                navFragment.appendChild(categoryBtn);
                
                const categoryEl = document.createElement('div');
                categoryEl.dataset.id = category.id;
                categoryEl.className = 'flex items-center bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 transition-shadow duration-200 cursor-pointer select-none';
                categoryEl.setAttribute('tabindex', '0');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = category.name;
                nameSpan.className = 'focus:outline-none';
                const kebabMenu = document.createElement('span');
                kebabMenu.innerHTML = '&#8942;';
                kebabMenu.className = 'kebab-menu';
                kebabMenu.title = 'ตัวเลือก';
                categoryEl.appendChild(nameSpan);
                categoryEl.appendChild(kebabMenu);
                kebabMenu?.addEventListener('click', (e) => { e.stopPropagation(); openCategoryActionsModal(category); });
                categoryEl?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); openCategoryActionsModal(category); } });
                manageFragment.appendChild(categoryEl);
            });

            categoryList.appendChild(navFragment);
            manageCategoryList.appendChild(manageFragment);
            appState.categorySortableInstance = new Sortable(manageCategoryList, { animation: 150, ghostClass: 'sortable-ghost', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: (evt) => { const newOrder = Array.from(manageCategoryList.querySelectorAll('div')).map(el => el.dataset.id); saveCategoryOrder(newOrder); } });
            }
        
        async function fetchWithRetry(url, retries = 3, delay = 2000) { for (let i = 0; i < retries; i++) { try { const response = await fetch(url);
        if (!response.ok) throw new Error(`Network: ${response.statusText}`); return await response.json(); } catch (error) { if (i === retries - 1) throw error;
        console.warn(`Fetch attempt ${i + 1} failed for ${url}. Retrying in ${delay / 1000}s...`); showNotification(`เชื่อมต่อไม่ได้ กำลังลองใหม่... (ครั้งที่ ${i + 1})`, true);
        await new Promise(res => setTimeout(res, delay)); } } }
async function fetchAllDataFromSheet() { 
            if (appState.initialDataLoaded) return;
            try { 
                loadingEl.classList.remove('hidden'); 
                const response = await fetchWithRetry(sheetUrl);
                
                // Debug: ดูค่าที่ Google ส่งกลับมาใน Console (กด F12 ดูได้)
                console.log("Response from Google:", response);

                // --- เพิ่มการเช็ค Error จากฝั่ง Google Script ---
                if (response && response.status === 'error') {
                    throw new Error("Google Script Error: " + response.message);
                }
                // ------------------------------------------

                let dataRows = [];
                let lastUpdated = null;

                if (Array.isArray(response)) {
                    dataRows = response; // แบบเก่า
                } else if (response.data) {
                    dataRows = response.data; // แบบใหม่
                    lastUpdated = response.lastUpdated;
                }

                if (!Array.isArray(dataRows) || dataRows.length === 0) { 
                    showNoData(); 
                    return;
                } 

                appState.allRecords = dataRows; 
                appState.currentFilteredRecords = [...appState.allRecords]; 
                appState.initialDataLoaded = true; 
                
                updateLastSavedTime(lastUpdated); 

                await categoriesLoadedPromise; 
                const carnationCategory = appState.categories.find(c => c.name === 'Carnation');
                if (carnationCategory) { 
                    const carnationButton = Array.from(categoryList.querySelectorAll('button')).find(btn => btn.textContent === 'Carnation'); 
                    if (carnationButton) carnationButton.click(); 
                    else displayData(); 
                } else { 
                    displayData();
                } 
            } catch (error) { 
                // แสดง Error สีแดงชัดเจน
                showError(error.message); 
            } finally { 
                loadingEl.classList.add('hidden');
            } 
        }
        
async function startSheetPolling() {
    setInterval(async () => {
        try {
            // เรียกข้อมูลแบบเงียบๆ
            const response = await fetch(sheetUrl);
            if (!response.ok) return; 
            
            const json = await response.json();
            if (!json.data || !Array.isArray(json.data)) return;

            // เปรียบเทียบข้อมูล
            const currentDataStr = JSON.stringify(appState.allRecords);
            const newDataStr = JSON.stringify(json.data);

            if (currentDataStr !== newDataStr && appState.allRecords.length > 0) {
                // --- แก้ไขตรงนี้ครับ ---
                appState.hasPendingUpdate = true; // ล็อกสถานะไว้ ไม่ให้ข้อความอื่นมาแทรก
                showNotification('พบข้อมูลใหม่จาก Google Sheets! กรุณารีเฟรช', 'info', 0);
            }
        } catch (err) {
            // เงียบไว้ถ้าเช็คไม่ได้ (เช่น เน็ตหลุดชั่วคราว)
            console.warn("Background sheet check failed:", err);
        }
    }, 30000); // เช็คทุก 30 วินาที
}

function displayData() {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // เคลียร์ Sortable เก่า
            if (appState.sortableInstance) {
                appState.sortableInstance.destroy();
                appState.sortableInstance = null;
            }

            const records = appState.currentFilteredRecords;
            let recordsToDisplay = records;
            
            // Logic การแบ่งหน้า (Pagination)
            const shouldPaginate = appState.activeCategoryName === 'ทั้งหมด';
            if (shouldPaginate) {
                const startIndex = (appState.currentPage - 1) * CONSTANTS.ITEMS_PER_PAGE;
                const endIndex = startIndex + CONSTANTS.ITEMS_PER_PAGE;
                recordsToDisplay = records.slice(startIndex, endIndex);
                renderPagination(records.length);
            } else {
                clearPagination();
            }

            if (appState.allRecords.length === 0) {
                showNoData();
                return;
            }

            const itemColumnName = Object.keys(appState.allRecords[0])[0] || '';
            
            // --- FIX: บังคับ Key เป็น String และ Trim ทั้งหมด ---
            appState.allRecordsMap = new Map(appState.allRecords.map(r => [String(r[itemColumnName]).trim(), r]));
            
            // รายการ ID ของสินค้าที่จะแสดงผลในหน้านี้
            const currentRecordIds = new Set(recordsToDisplay.map(r => String(r[itemColumnName]).trim()));
            
            const sortKey = appState.activeCategoryName || CONSTANTS.SORT_KEY_GLOBAL;
            const hiddenIdsForCurrentCategory = appState.hiddenItemsMap[sortKey] || new Set();
            
            // ดึงลำดับที่เคยบันทึกไว้ (Force String)
            const currentItemOrder = (appState.sortOrdersMap[sortKey] || []).map(id => String(id).trim());

            // --- FIX: Logic การรวมข้อมูล ---
            // 1. เอาลำดับที่บันทึกไว้เป็นหลัก
            // 2. ต่อด้วยสินค้าใหม่ที่ยังไม่มีในบันทึก (มาจาก Sheet)
            // 3. ใช้ Set เพื่อตัดตัวซ้ำ
            const allRecordKeysFromSheet = records.map(r => String(r[itemColumnName]).trim());
            const combinedOrder = [...new Set([...currentItemOrder, ...allRecordKeysFromSheet])];

            // กรองเอาเฉพาะตัวที่มีอยู่จริงใน Sheet (ป้องกัน ID ขยะที่ลบไปแล้วแต่ยังค้างใน Sort Order) หรือเป็นหัวข้อ (Custom Row)
            const validOrder = combinedOrder.filter(id => appState.customRows.has(id) || appState.allRecordsMap.has(id));

            // กรองตัวที่ซ่อนออก
            const visibleIds = new Set(validOrder.filter(id => !hiddenIdsForCurrentCategory.has(id)));

            // กรองให้เหลือเฉพาะ:
            // 1. หัวข้อ (Custom Row) ของหมวดหมู่นี้
            // 2. สินค้า ที่อยู่ในหน้าปัจจุบัน (Pagination scope)
            const finalDisplayOrder = validOrder.filter(id => {
                if (appState.customRows.has(id)) {
                    return appState.customRows.get(id).categoryName === appState.activeCategoryName;
                }
                return currentRecordIds.has(id);
            });

            if (finalDisplayOrder.filter(id => visibleIds.has(id)).length === 0) {
                tableEl.classList.add('hidden');
                noDataEl.classList.remove('hidden');
                return;
            }
            
            noDataEl.classList.add('hidden');
            tableEl.classList.remove('hidden');

            // สร้าง Header ตาราง
            const headers = Object.keys(appState.allRecords[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                const narrowColumns = ['รวม', 'หน่วย', CONSTANTS.SHEET_COLUMN_NAMES.TRIGGER_STOCK, CONSTANTS.SHEET_COLUMN_NAMES.CALCULATION_STOCK];
                let alignment = narrowColumns.includes(header) ? 'text-center' : 'text-left';
                let padding = narrowColumns.includes(header) ? 'px-1' : 'px-2 sm:px-6';
                th.className = `${padding} py-1 ${alignment} text-sm font-medium text-gray-500 uppercase ${header === itemColumnName ? 'w-full' : ''}`;
                th.textContent = header.replace(/_/g, ' ');
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // สร้างเนื้อหาตาราง
            const bodyFragment = document.createDocumentFragment();
            finalDisplayOrder.forEach(id => {
                if (!visibleIds.has(id)) return;
                
                const row = document.createElement('tr');
                row.dataset.id = id; 

                if (appState.customRows.has(id)) {
                    const rowData = appState.customRows.get(id);
                    if (rowData.categoryName === appState.activeCategoryName) {
                        row.className = 'bg-gray-200 font-bold';
                        const cell = document.createElement('td');
                        cell.colSpan = headers.length;
                        cell.className = 'px-4 py-0.5 text-gray-800 text-sm text-left cursor-move'; 
                        cell.textContent = rowData.text;
                        cell.setAttribute('tabindex', '-1');
                        row.addEventListener('dblclick', () => {
                            openHeaderActionsModal(id, rowData.text);
                        });
                        row.appendChild(cell);
                        bodyFragment.appendChild(row);
                    }
                } else if (appState.allRecordsMap.has(id)) {
                    const record = appState.allRecordsMap.get(id);
                    row.className = 'hover:bg-gray-50';
                    row.setAttribute('tabindex', '0');

                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.setAttribute('tabindex', '-1');
                        const narrowColumns = ['รวม', 'หน่วย', CONSTANTS.SHEET_COLUMN_NAMES.TRIGGER_STOCK, CONSTANTS.SHEET_COLUMN_NAMES.CALCULATION_STOCK];
                        let alignment = narrowColumns.includes(header) ? 'text-center' : 'text-left';
                        let padding = narrowColumns.includes(header) ? 'px-1' : 'px-2 sm:px-6';
                        td.className = `${padding} py-1 ${alignment} text-sm text-gray-700 break-words ${header === itemColumnName ? 'w-full' : ''}`;
                        td.textContent = record[header];
                        row.appendChild(td);
                    });
                    bodyFragment.appendChild(row);
                }
            });
            tableBody.appendChild(bodyFragment);

            // สร้าง Sortable ใหม่
            appState.sortableInstance = new Sortable(tableBody, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                delay: 200,
                touchStartThreshold: 5,
                onEnd: (evt) => {
                    const newOrder = Array.from(tableBody.querySelectorAll('tr')).map(row => row.dataset.id);
                    saveCurrentSortOrder(newOrder);
                }
            });
        }

        function renderPagination(totalItems) { clearPagination(); const totalPages = Math.ceil(totalItems / CONSTANTS.ITEMS_PER_PAGE);
        if (totalPages <= 1) return; const prevButton = document.createElement('button'); prevButton.textContent = 'ก่อนหน้า'; prevButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md disabled:opacity-50';
        prevButton.disabled = appState.currentPage === 1; prevButton?.addEventListener('click', () => { if (appState.currentPage > 1) { appState.currentPage--; displayData(); } });
        const pageInfo = document.createElement('span'); pageInfo.textContent = `หน้า ${appState.currentPage} จาก ${totalPages}`; pageInfo.className = 'text-sm text-gray-600'; const nextButton = document.createElement('button');
        nextButton.textContent = 'ถัดไป'; nextButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md disabled:opacity-50'; nextButton.disabled = appState.currentPage === totalPages;
        nextButton?.addEventListener('click', () => { if (appState.currentPage < totalPages) { appState.currentPage++; displayData(); } }); paginationControls.appendChild(prevButton); paginationControls.appendChild(pageInfo); paginationControls.appendChild(nextButton);
        }
        function clearPagination() { paginationControls.innerHTML = '';
        }
        function displayRequisitionList() {
            requisitionListBody.innerHTML = '';
            const hasItems = appState.requisitionList.length > 0;
            confirmRequisitionBtn.disabled = !hasItems;
            if (!hasItems) {
                requisitionListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">ไม่มีรายการที่ต้องเบิก</td></tr>';
            return;
            }
            const fragment = document.createDocumentFragment();
            appState.requisitionList.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm text-gray-600 text-center">${index + 1}</td>
                    <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm text-gray-800 font-medium break-words">${item.name}</td>
   
                     <td class="px-1 sm:px-2 py-2 text-center">
                        <div class="flex items-center justify-center">
                            <button class="quantity-change-btn h-8 w-8 rounded-l-md border bg-gray-200 text-gray-600 hover:bg-gray-300" data-id="${item.id}" data-amount="-1">-</button>
          
                           <span class="requisition-quantity-display h-8 w-12 text-center border-t border-b bg-white flex items-center justify-center" data-id="${item.id}">${item.quantity}</span>
                            <button class="quantity-change-btn h-8 w-8 rounded-r-md border bg-gray-200 text-gray-600 hover:bg-gray-300" data-id="${item.id}" data-amount="1">+</button>
                    
                        </div>
             
               </td>
                    <td class="px-1 sm:px-2 py-2 text-xs sm:text-sm text-gray-600 text-center">${item.unit}</td>
                    <td class="px-1 sm:px-2 py-2 text-center text-xs sm:text-sm font-medium">
              
                        <button class="delete-req-btn text-red-600 hover:text-red-900 p-1" data-id="${item.id}" data-name="${item.name}">ลบ</button>
         
                   </td>`;
            fragment.appendChild(row);
            });
            requisitionListBody.appendChild(fragment);
        }
        function displayHistory() {
  // Ensure toolbar exists
  const bodyEl = document.getElementById('history-table-body');
  const pagEl = document.getElementById('history-pagination');
  const searchEl = document.getElementById('history-search');
  const startEl = document.getElementById('history-date-start');
  const endEl = document.getElementById('history-date-end');
  const exportBtn = document.getElementById('history-export');
  const printBtn = document.getElementById('history-print');

  // Fallback to old container if new UI missing
  if (!bodyEl || !pagEl) {
    // fallback: do nothing, keep old renderer
    return;
  }

  // Initialize state singletons
  if (!window.__histFilters) {
    window.__histFilters = { q: '', start: null, end: null, page: 1, pageSize: 20 };
}
  const F = window.__histFilters;

  function parseDateOnly(tsSeconds) {
    const d = new Date((tsSeconds || 0) * 1000);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function inRange(tsSeconds, start, end) {
    const d = parseDateOnly(tsSeconds);
    if (start && d < start) return false;
    if (end && d > end) return false;
    return true;
  }

  function matchQuery(rec, q) {
    if (!q) return true;
    const hay = [
      rec.requisitionNumber ||
      '',
      ...(Array.isArray(rec.items) ? rec.items.map(i => `${i.name||''} ${i.unit||''}`) : [])
    ].join(' ').toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function applyFilters(list) {
    const start = F.start ? new Date(F.start) : null;
    const end = F.end ? new Date(F.end) : null;
    const startDay = start ? new Date(start.getFullYear(), start.getMonth(), start.getDate()) : null;
    const endDay = end ? new Date(end.getFullYear(), end.getMonth(), end.getDate()) : null;
    return list.filter(h => inRange(h.timestamp?.seconds || 0, startDay, endDay) && matchQuery(h, F.q));
}

  function fmtDate(tsSeconds) {
    const d = new Date((tsSeconds || 0) * 1000);
    const pad = n => n.toString().padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function renderPagination(total) {
    const pages = Math.max(1, Math.ceil(total / F.pageSize));
    if (F.page > pages) F.page = pages;
    pagEl.innerHTML = `
      <div class="text-sm text-gray-600">รวม ${total} รายการ • หน้า ${F.page}/${pages}</div>
      <div class="flex gap-2">
        <button id="hist-prev" class="px-3 py-1 border rounded ${F.page<=1?'opacity-50 cursor-not-allowed':''}">ก่อนหน้า</button>
        <button id="hist-next" class="px-3 py-1 border rounded ${F.page>=pages?'opacity-50 cursor-not-allowed':''}">ถัดไป</button>
      </div>
    `;
    const prev = document.getElementById('hist-prev');
    const next = document.getElementById('hist-next');
    prev && prev?.addEventListener('click', () => { if (F.page>1){F.page--; displayHistory();} });
    next && next?.addEventListener('click', () => { const p = Math.max(1, Math.ceil(total / F.pageSize)); if (F.page<p){F.page++; displayHistory();} });
}

  function buildDetailRows(items) {
    if (!Array.isArray(items) || items.length === 0) {
      return `<tr class="bg-gray-50"><td colspan="6" class="p-3 text-sm text-gray-500">ไม่มีรายการ</td></tr>`;
}
    return items.map((it, idx) => `
      <tr class="bg-gray-50">
        <td class="p-2 pl-6 text-xs text-gray-500">#${idx+1}</td>
        <td class="p-2 text-sm">${it.name||''}</td>
        <td class="p-2 text-center text-sm">${it.quantity||0}</td>
        <td class="p-2 text-center text-sm">${it.unit||''}</td>
        <td class="p-2 text-sm" colspan="2"></td>
      </tr>
    `).join('');
}

  // Data source
  const all = Array.isArray(appState?.historyList) ? appState.historyList.slice() : [];

  const filtered = applyFilters(all);
  const startIdx = (F.page - 1) * F.pageSize;
  const pageList = filtered.slice(startIdx, startIdx + F.pageSize);
  bodyEl.innerHTML = pageList.map(rec => {
    const totalItems = typeof rec.totalItems === 'number' ? rec.totalItems : (Array.isArray(rec.items) ? rec.items.length : 0);
    // removed totalQtylQty : (Array.isArray(rec.items) ? rec.items.reduce((s, it)=>s + (parseInt(it.quantity,10)||0), 0) : 0);
    const rid = `row-${rec.id || rec.requisitionNumber || Math.random().toString(36).slice(2)}`;
    return `
      <tr data-id="${rid}" class="hover:bg-gray-50">
        <td class="p-2 text-sm font-medium text-blue-700">${rec.requisitionNumber||'-'}</td>
        <td class="p-2 text-sm">${rec.timestamp?.seconds ? fmtDate(rec.timestamp.seconds) : '-'}</td>
        <td class="p-2 text-center text-sm">${totalItems}</td>
 
       <td class="p-2 text-center">
          <button class="hist-toggle px-2 py-1 border rounded text-xs">รายละเอียด</button>
        </td>
      </tr>
      <tr class="hidden" data-detail="${rid}">
        <td colspan="4" class="p-0">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
     
           <th class="p-2 pl-6 text-left text-xs text-gray-600 uppercase">#</th>
                <th class="p-2 text-left text-xs text-gray-600 uppercase">สินค้า</th>
                <th class="p-2 text-center text-xs text-gray-600 uppercase">จำนวน</th>
                <th class="p-2 text-center text-xs text-gray-600 uppercase">หน่วย</th>
                <th class="p-2 text-left text-xs 
text-gray-600 uppercase" colspan="2"></th>
              </tr>
            </thead>
            <tbody>
              ${buildDetailRows(rec.items)}
            </tbody>
          </table>
        </td>
      </tr>
    `;
}).join('');

  // Toggle details
  bodyEl.querySelectorAll('.hist-toggle').forEach(btn => {
    btn?.addEventListener('click', e => {
      const tr = e.target.closest('tr');
      const id = tr?.dataset.id;
      const detail = bodyEl.querySelector(`tr[data-detail="${id}"]`);
      if (detail) detail.classList.toggle('hidden');
    });
  });
  renderPagination(filtered.length);

  // One-time event bindings
  if (!window.__histBound) {
    window.__histBound = true;
    if (searchEl) searchEl?.addEventListener('input', e => { window.__histFilters.q = e.target.value.trim(); window.__histFilters.page = 1; displayHistory(); });
    if (startEl) startEl?.addEventListener('change', e => { window.__histFilters.start = e.target.value || null; window.__histFilters.page = 1; displayHistory(); });
    if (endEl) endEl?.addEventListener('change', e => { window.__histFilters.end = e.target.value || null; window.__histFilters.page = 1; displayHistory(); });
    if (exportBtn) exportBtn?.addEventListener('click', () => {
      const rows = applyFilters(all);
      const header = ['requisitionNumber','timestamp','totalItems'];
      const csv = [ header.join(','), ...rows.map(r => {
        const t = r.timestamp?.seconds ? new Date(r.timestamp.seconds*1000).toISOString() : '';
        const ti = typeof r.totalItems === 'number' ? r.totalItems : (Array.isArray(r.items)?r.items.length:0);
        const tq = typeof r.totalQty === 'number' ? r.totalQty : (Array.isArray(r.items)?r.items.reduce((s,it)=>s+(parseInt(it.quantity,10)||0),0):0);
        return [
   
       `\"${(r.requisitionNumber||'').replace(/\"/g,'\"\"')}\"`,
          `\"${t}\"`,
          ti
        ].join(',');
      })].join('\\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'requisition_history.csv';
      link.click();
    });
    if (printBtn) printBtn?.addEventListener('click', () => window.print());
  }
}

        function enableCategoryEditing(category) { const categoryEl = manageCategoryList.querySelector(`div[data-id="${category.id}"]`);
        if (!categoryEl) return; const nameSpan = categoryEl.querySelector('span:first-child'); const kebabMenu = categoryEl.querySelector('.kebab-menu'); const input = document.createElement('input'); input.type = 'text';
        input.value = category.name; input.className = 'editing-input'; const saveChanges = () => { const newName = input.value.trim();
        if (newName && newName !== category.name) { updateCategoryName(category.id, category.name, newName); } setTimeout(displayCategories, 200); }; input?.addEventListener('blur', saveChanges);
        input?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } else if (e.key === 'Escape') { input.removeEventListener('blur', saveChanges); input.blur(); displayCategories(); } });
        nameSpan.style.display = 'none'; kebabMenu.style.display = 'none'; categoryEl.insertBefore(input, kebabMenu); input.focus(); input.select();
        }
        
        // --- FIXED: ฟังก์ชันใหม่สำหรับแก้ไข Header ---
        function enableHeaderEditing(headerId, currentText) {
            const headerRow = tableBody.querySelector(`tr[data-id="${headerId}"]`);
            if (!headerRow || !headerRow.firstChild) return;

            const cell = headerRow.firstChild;
            const originalContent = cell.innerHTML;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'w-full bg-gray-200 p-1 text-sm text-gray-800 border-blue-500 border-2 rounded';
            const saveChanges = () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    editHeaderRow(headerId, newText);
                } else {
                    // Restore original if no change or empty
                    cell.innerHTML = originalContent;
                    cell.textContent = currentText; // Ensure text is correct
                }
            };
            input?.addEventListener('blur', saveChanges);
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                } else if (e.key === 'Escape') {
             
                   input.removeEventListener('blur', saveChanges);
                    input.blur();
                    cell.innerHTML = originalContent;
                    cell.textContent = currentText;
                
                }
            
            });
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }
        
        function openItemSettingsModal(record) { const itemColumnName = Object.keys(appState.allRecords[0])[0] ||
        ''; appState.currentEditingItemId = record[itemColumnName]; const settings = appState.itemSettings.get(appState.currentEditingItemId) || {}; modalItemName.textContent = `ตั้งค่า: ${appState.currentEditingItemId}`; reorderPointInput.value = settings.reorderPoint || '';
        reorderQuantityInput.value = settings.reorderQuantity || ''; itemSettingsModal.classList.remove('hidden'); }
        function closeItemSettingsModal() { itemSettingsModal.classList.add('hidden');
        appState.currentEditingItemId = null; }
        function openCategoryActionsModal(category) { appState.currentEditingCategory = category;
        categoryModalName.textContent = `จัดการหมวดหมู่: ${category.name}`; categoryActionsModal.classList.remove('hidden'); }
        function closeCategoryActionsModal() { categoryActionsModal.classList.add('hidden'); appState.currentEditingCategory = null;
        }
        function openAddHeaderModal(referenceId = null) { appState.insertHeaderAboveId = referenceId; headerInput.value = ''; addHeaderModal.classList.remove('hidden');
        setTimeout(() => headerInput.focus(), 100); }
        function closeAddHeaderModal() { addHeaderModal.classList.add('hidden'); appState.insertHeaderAboveId = null;
        }
        function openHeaderActionsModal(id, text) { appState.currentEditingHeaderId = id; appState.currentEditingHeaderText = text;
        headerModalName.textContent = `จัดการหัวข้อ: "${text}"`; headerActionsModal.classList.remove('hidden'); }
        function closeHeaderActionsModal() { headerActionsModal.classList.add('hidden'); appState.currentEditingHeaderId = null;
        appState.currentEditingHeaderText = null; }
        function showConfirmModal(title, body, onConfirm) { confirmModalTitle.textContent = title;
        confirmModalBody.textContent = body; appState.confirmCallback = onConfirm; confirmModal.classList.remove('hidden'); }
        function closeConfirmModal() { confirmModal.classList.add('hidden');
        appState.confirmCallback = null; }
        function openAppSettingsModal() { updateAppSettingsModalInputs(); appSettingsModal.classList.remove('hidden');
        }
        function closeAppSettingsModal() { appSettingsModal.classList.add('hidden');
        }
        function updateAppSettingsModalInputs() { settingTriggerColInput.value = appState.appSettings.triggerStockColumnName; settingCalcColInput.value = appState.appSettings.calculationStockColumnName; settingUnitColInput.value = appState.appSettings.unitColumnName;
        }

function showNotification(message, type = 'success', duration = 3000) { 
    // 1. ถ้ามีคิวอัปเดตค้างอยู่ และข้อความใหม่ *ไม่ใช่* เรื่องอัปเดต -> ให้บล็อกข้อความอื่นทิ้งไปเลย
    if (appState.hasPendingUpdate && message !== 'พบข้อมูลใหม่จาก Google Sheets! กรุณารีเฟรช') {
        return; 
    }

    const toast = document.getElementById('notification-toast');
    const msgEl = document.getElementById('notification-message');
    const iconEl = document.getElementById('notification-icon');

    // 2. ถ้าข้อความเดิมแสดงอยู่แล้ว (ป้องกันการกระพริบเมื่อ Polling ทำงานซ้ำ)
    if (toast.classList.contains('show') && msgEl.textContent === message) {
        return;
    }

    if (appState.notificationTimeout) clearTimeout(appState.notificationTimeout);

    let bgClass = '';
    let iconHtml = '';
    
    // แปลงค่า type กรณีส่งมาเป็น boolean
    if (type === true) type = 'error';
    if (type === false) type = 'success';

    switch(type) {
        case 'error':
            bgClass = 'toast-error';
            iconHtml = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            break;
        case 'info':
            bgClass = 'toast-info';
            iconHtml = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            break;
        case 'success':
        default:
            bgClass = 'toast-success';
            iconHtml = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            break;
    }

    // Reset Classes
    toast.className = 'fixed z-50 flex items-center gap-2 px-6 py-3 rounded-full shadow-lg transition-all duration-300 transform translate-y-full opacity-0 cursor-pointer';
    toast.classList.add(bgClass); 
    toast.classList.remove('hidden');
    
    // --- 3. ตั้งค่าการคลิก ---
    toast.onclick = function() {
        // ถ้าเป็นโหมด duration 0 (แจ้งเตือนถาวร) คลิกแล้วให้รีเฟรชหน้าจอเลย
        if (duration === 0) {
            window.location.reload();
        } else {
            // โหมดปกติ คลิกแล้วปิด
            toast.classList.remove('show');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }
    };

    msgEl.textContent = message;
    if(iconEl) iconEl.innerHTML = iconHtml;

    // Animation Show
    requestAnimationFrame(() => {
        toast.classList.add('show');
    });

    // Auto Hide Logic (ทำงานเฉพาะเมื่อ duration > 0)
    if (duration > 0) {
        appState.notificationTimeout = setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, duration);
    }
}

// ฟังก์ชันแสดงเวลา (แก้ให้รับ parameter 'serverTime')
function updateLastSavedTime(serverTime) {
    const statusText = document.getElementById('last-update-text');
    if (!statusText) return;

    let timeString = 'ไม่ทราบเวลา';

    if (serverTime) {
        const dateObj = new Date(serverTime);
        // แก้ไขตรงนี้ให้แสดงวันที่ด้วย
        timeString = dateObj.toLocaleString('th-TH', { 
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        }) + ' น.';
    }

    // อัปเดตข้อความ
    statusText.innerHTML = `
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>อัปเดตล่าสุด : ${timeString}</span>
    `;
}
        function switchView(viewName) { const views = { products: productListView, requisition: requisitionView, history: historyView, manage: manageView, account: accountView };
        const navs = { products: navProductsBtn, requisition: navRequisitionBtn, history: navHistoryBtn, manage: navManageBtn, account: navAccountBtn }; Object.values(views).forEach(v => v.classList.add('hidden')); categoryNavView.classList.add('hidden');
        Object.values(navs).forEach(n => { n.classList.remove('text-blue-600', 'border-blue-600'); n.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent'); }); views[viewName].classList.remove('hidden'); navs[viewName].classList.add('text-blue-600', 'border-blue-600'); navs[viewName].classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
        if (viewName === 'products') { categoryNavView.classList.remove('hidden'); if(appState.activeCategoryName === 'ทั้งหมด') { productSearchContainer.classList.remove('hidden'); } } else { productSearchContainer.classList.add('hidden');
        } }
        function showError(message) { errorMessageEl.textContent = `เกิดข้อผิดพลาด: ${message}`; errorEl.classList.remove('hidden');
        }
        function showNoData() { noDataEl.querySelector('p').textContent = 'ไม่พบข้อมูล'; noDataEl.classList.remove('hidden'); tableEl.classList.add('hidden');
        }
        function openQuantityModal(item) {
            const itemColumnName = Object.keys(appState.allRecords[0])[0] ||
            '';
            if (!item || !item[itemColumnName]) return;
            appState.itemForRequisition = item;
            quantityModalName.textContent = `ระบุจำนวนสำหรับ: ${item[itemColumnName]}`;
            quantityDisplay.textContent = '1';
            quantityModal.classList.remove('hidden');
        }
        function closeQuantityModal() { quantityModal.classList.add('hidden'); appState.itemForRequisition = null;
        }
        function openContextMenu(event, record) { const targetElement = event.target.closest('tr'); if (!targetElement) return;
        let mouseX, mouseY; if (event.clientX !== undefined && event.clientY !== undefined && event.clientX !== 0) { mouseX = event.clientX;
        mouseY = event.clientY; } else { const rect = targetElement.getBoundingClientRect(); mouseX = rect.left; mouseY = rect.top; } appState.contextMenuItemRecord = record;
        itemContextMenu.style.top = `${mouseY}px`; itemContextMenu.style.left = `${mouseX}px`; itemContextMenu.classList.remove('hidden'); const menuRect = itemContextMenu.getBoundingClientRect();
        if (menuRect.bottom > window.innerHeight) { itemContextMenu.style.top = `${mouseY - menuRect.height}px`;
        } if (menuRect.right > window.innerWidth) { itemContextMenu.style.left = `${mouseX - menuRect.width}px`; } itemContextMenu.setAttribute('tabindex', '-1'); itemContextMenu.focus(); itemContextMenu?.addEventListener('keydown', handleMenuKeyDown);
        const firstItem = itemContextMenu.querySelector('button[role="menuitem"]'); if(firstItem) firstItem.classList.add('menu-item-active'); }
        function closeContextMenu() { if (itemContextMenu && !itemContextMenu.classList.contains('hidden')) { itemContextMenu.removeEventListener('keydown', handleMenuKeyDown);
        const activeItem = itemContextMenu.querySelector('.menu-item-active'); if (activeItem) activeItem.classList.remove('menu-item-active'); itemContextMenu.classList.add('hidden'); appState.contextMenuItemRecord = null;
        } }
        function handleMenuKeyDown(event) { event.preventDefault(); event.stopPropagation(); const menuItems = Array.from(itemContextMenu.querySelectorAll('button[role="menuitem"]'));
        if (menuItems.length === 0) return; const activeItem = itemContextMenu.querySelector('.menu-item-active'); let currentIndex = activeItem ? menuItems.indexOf(activeItem) : -1;
        switch (event.key) { case 'ArrowDown': currentIndex = (currentIndex === -1 || currentIndex === menuItems.length - 1) ?
        0 : currentIndex + 1; break; case 'ArrowUp': currentIndex = (currentIndex === -1 || currentIndex === 0) ?
        menuItems.length - 1 : currentIndex - 1; break; case 'Enter': case ' ': if (activeItem) activeItem.click(); return; case 'Escape': closeContextMenu();
        return; } if(activeItem) activeItem.classList.remove('menu-item-active'); menuItems[currentIndex].classList.add('menu-item-active'); }

        productSearchInput?.addEventListener('input', () => { const searchTerm = productSearchInput.value.toLowerCase(); const itemColumnName = appState.allRecords.length > 0 ? Object.keys(appState.allRecords[0])[0] : ''; if (!itemColumnName) return; appState.currentFilteredRecords = searchTerm ? appState.allRecords.filter(record => record[itemColumnName] && record[itemColumnName].toLowerCase().includes(searchTerm)) : appState.allRecords; appState.currentPage = 1; displayData(); });
        categoryList?.addEventListener('wheel', (event) => { if (window.matchMedia('(pointer: fine)').matches) { event.preventDefault(); categoryList.scrollLeft += event.deltaY; } }, { passive: false });
        addCategoryBtn?.addEventListener('click', addCategory);
        categoryInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') addCategory(); });
        navProductsBtn?.addEventListener('click', () => switchView('products'));
        navRequisitionBtn?.addEventListener('click', () => switchView('requisition'));
        navHistoryBtn?.addEventListener('click', () => switchView('history'));
        navManageBtn?.addEventListener('click', () => switchView('manage'));
        navAccountBtn?.addEventListener('click', () => switchView('account'));
        modalOkBtn?.addEventListener('click', saveItemSettings);
        modalCancelBtn?.addEventListener('click', closeItemSettingsModal);
        editCategoryBtn?.addEventListener('click', () => { if (appState.currentEditingCategory) { enableCategoryEditing(appState.currentEditingCategory); closeCategoryActionsModal(); } });
        deleteCategoryBtn?.addEventListener('click', () => { if (appState.currentEditingCategory) { showConfirmModal('ยืนยันการลบ', `ต้องการลบหมวดหมู่ "${appState.currentEditingCategory.name}" หรือไม่?`, () => { deleteCategory(appState.currentEditingCategory.id, appState.currentEditingCategory.name); closeCategoryActionsModal(); }); } });
        categoryModalCancelBtn?.addEventListener('click', closeCategoryActionsModal);
        categoryActionsModal?.addEventListener('click', (e) => { if (e.target === categoryActionsModal) { closeCategoryActionsModal(); } });
        headerModalOkBtn?.addEventListener('click', async () => { const headerText = headerInput.value.trim(); if (headerText) { await addHeaderRow(headerText); closeAddHeaderModal(); } });
        headerModalCancelBtn?.addEventListener('click', closeAddHeaderModal);
        headerInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const headerText = headerInput.value.trim(); if (headerText) { addHeaderRow(headerText); closeAddHeaderModal(); } } });
        addHeaderModal?.addEventListener('click', (e) => { if (e.target === addHeaderModal) { closeAddHeaderModal(); } });
async function sendLineMessage(reqNumber, items) {
    const LINE_TOKEN = 'LVYF+0mbL7RSwwtbY6bwl9dtiaOTe4vBaI9RA+I3qT196Zz7xzUUD4pa41xK3Sbv8ro9mFXrPFXUwZoPxg2q4SOUVHiZt5/bAmotWxbp/puinybZAgRhtMcHwimbzCtxQcH4/254U8jlTZFnhiU3tgdB04t89/1O/w1cDnyilFU=';
    const GROUP_ID = 'C9720dae16795d18cd7d49637a143d499';

    // ตรวจสอบว่ามีรายการสินค้าหรือไม่
    if (!items || items.length === 0) return;

    // สร้างข้อความรายการสินค้า
    const itemDetails = items.map((it, idx) => {
        const name = it.name || it.itemName || 'ไม่ระบุชื่อ';
        const qty = it.quantity || 0;
        const unit = it.unit || '';
        return `${idx + 1}. ${name} : ${qty} ${unit}`;
    }).join('\n');

    const messageText = `📦 มีรายการเบิกใหม่!\nเลขที่: ${reqNumber}\n------------------\n${itemDetails}\n------------------\nตรวจสอบได้ในระบบ`;

    try {
        const response = await fetch('https://api.line.me/v2/bot/message/push', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${LINE_TOKEN}`
            },
            body: JSON.stringify({
                to: GROUP_ID,
                messages: [{ type: 'text', text: messageText }]
            })
        });

        if (response.ok) {
            console.log("LINE Message sent successfully");
        } else {
            const errorData = await response.json();
            console.error("LINE API Error:", errorData);
        }
    } catch (error) {
        console.error("Network Error (อาจติด CORS):", error);
    }
}
        // --- FIXED: อัปเดต event listener ให้เรียกใช้ฟังก์ชันแก้ไขใหม่ ---
        editHeaderBtn?.addEventListener('click', () => {
            if (appState.currentEditingHeaderId && appState.currentEditingHeaderText) {
                // 1. เก็บค่า ID และ Text ไว้ในตัวแปรชั่วคราวก่อน
                const idToEdit = appState.currentEditingHeaderId;
                const textToEdit = appState.currentEditingHeaderText;

                  // 2. จากนั้นค่อยปิด Modal (ซึ่งจะล้างค่าใน appState)
                closeHeaderActionsModal();

                // 3. เรียกใช้ฟังก์ชันแก้ไข โดยใช้ค่าจากตัวแปรที่เก็บไว้
                enableHeaderEditing(idToEdit, textToEdit);
            }
        });
        deleteHeaderBtn?.addEventListener('click', () => { if(appState.currentEditingHeaderId) { showConfirmModal('ยืนยันการลบ', `ต้องการลบหัวข้อ "${appState.currentEditingHeaderText}" หรือไม่?`, () => { deleteHeaderRow(appState.currentEditingHeaderId, appState.currentEditingHeaderText); closeHeaderActionsModal(); }); } });
        headerActionsCancelBtn?.addEventListener('click', closeHeaderActionsModal);
        headerActionsModal?.addEventListener('click', (e) => { if (e.target === headerActionsModal) { closeHeaderActionsModal(); }});
        confirmModalOkBtn?.addEventListener('click', () => { if (typeof appState.confirmCallback === 'function') { appState.confirmCallback(); } closeConfirmModal(); });
        confirmModalCancelBtn?.addEventListener('click', closeConfirmModal);
        appSettingsBtn?.addEventListener('click', openAppSettingsModal);
        appSettingsSaveBtn?.addEventListener('click', saveAppSettings);
        appSettingsCancelBtn?.addEventListener('click', closeAppSettingsModal);
        autoRequisitionBtn?.addEventListener('click', generateAutoRequisition);
        
        requisitionListBody?.addEventListener('click', (e) => {
            if (e.target.classList.contains('quantity-change-btn')) {
                const id = e.target.dataset.id;
                const amount = parseInt(e.target.dataset.amount);
                const display = requisitionListBody.querySelector(`span.requisition-quantity-display[data-id="${id}"]`);
                if (display) {
    
                    let newQuantity = parseInt(display.textContent) + amount;
                    if (newQuantity < 1) {
                        newQuantity = 1;
                    }
     
    
                   display.textContent = newQuantity;
                    updateRequisitionQuantity(id, newQuantity);
                }
            } else if (e.target.classList.contains('delete-req-btn')) {
                deleteRequisitionItem(e.target.dataset.id, e.target.dataset.name);
            }
     
           });
        confirmRequisitionBtn?.addEventListener('click', confirmRequisition);

        // --- IMPROVEMENT: Event Delegation สำหรับ table body ---
        tableBody?.addEventListener('contextmenu', e => {
            const row = e.target.closest('tr[data-id]');
            if (!row || appState.customRows.has(row.dataset.id)) return; // ไม่ทำงานกับแถว header
            const record = appState.allRecordsMap.get(row.dataset.id);
            if(record) {
             
               e.preventDefault();
                openContextMenu(e, record);
            }
        });
        tableBody?.addEventListener('touchstart', e => {
            const row = e.target.closest('tr[data-id]');
            if (!row || appState.customRows.has(row.dataset.id)) return;
            const record = appState.allRecordsMap.get(row.dataset.id);
            if (!record) return;

            const rowId = row.dataset.id;
            const currentTime = new Date().getTime();
      
               const tapLength = currentTime - lastTap.time;
            
            if (tapLength < 400 && tapLength > 0 && lastTap.id === rowId) {
                e.preventDefault();
                const touch = e.touches[0];
         
               const fakeEvent 
= { clientX: touch.clientX, clientY: touch.clientY, target: e.target };
                openContextMenu(fakeEvent, record);
                lastTap = { time: 0, id: null };
            } else {
                lastTap = { time: currentTime, id: rowId };
      
      }
   
             });
        tableBody?.addEventListener('keydown', e => {
             if (e.key === 'Enter' || e.key === ' ') {
                const row = e.target.closest('tr[data-id]');
                if (!row || appState.customRows.has(row.dataset.id)) return;
                const record = appState.allRecordsMap.get(row.dataset.id);
           
      
           if (record) {
                    e.preventDefault();
                    openContextMenu(e, record);
                }
            }
        });
        window.addEventListener('click', (e) => { if (itemContextMenu && !itemContextMenu.classList.contains('hidden') && !itemContextMenu.contains(e.target)) { closeContextMenu(); } });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !itemContextMenu.classList.contains('hidden')) closeContextMenu(); });
        contextMenuSettingsBtn?.addEventListener('click', () => { if (appState.contextMenuItemRecord) openItemSettingsModal(appState.contextMenuItemRecord); closeContextMenu(); });
        contextMenuHideBtn?.addEventListener('click', () => { const itemColumnName = appState.allRecords.length > 0 ? Object.keys(appState.allRecords[0])[0] : ''; if (appState.contextMenuItemRecord && itemColumnName) { hideItem(appState.contextMenuItemRecord[itemColumnName], appState.contextMenuItemRecord[itemColumnName]); } closeContextMenu(); });
        const contextMenuRequisitionBtn = document.getElementById('context-menu-requisition');
        contextMenuRequisitionBtn?.addEventListener('click', () => { if (appState.contextMenuItemRecord) { openQuantityModal(appState.contextMenuItemRecord); } closeContextMenu(); });
        contextMenuAddHeaderBtn?.addEventListener('click', () => { const itemColumnName = appState.allRecords.length > 0 ? Object.keys(appState.allRecords[0])[0] : ''; if (appState.contextMenuItemRecord && itemColumnName) { openAddHeaderModal(appState.contextMenuItemRecord[itemColumnName]); } closeContextMenu(); });
        quantityModalOkBtn?.addEventListener('click', () => {
            const quantity = parseInt(quantityDisplay.textContent, 10);
            if (appState.itemForRequisition && quantity > 0) {
                addManualRequisition(appState.itemForRequisition, quantity);
                closeQuantityModal();
            } else {
                
                showNotification('กรุณาใส่จำนวนที่มากกว่า 0', true);
            }
        });
        quantityModalCancelBtn?.addEventListener('click', closeQuantityModal);

        quantityModal?.addEventListener('click', (e) => {
            if (e.target.classList.contains('quantity-modal-change-btn')) {
                const amount = parseInt(e.target.dataset.amount);
                let newQuantity = parseInt(quantityDisplay.textContent) + amount;
                if (newQuantity < 1) {
                    newQuantity 
= 1;
                }
                quantityDisplay.textContent = newQuantity;
            }
        });
        function handleTableKeyDown(e) { const currentCell = e.target.closest('td, th'); if (!currentCell || !tableEl.contains(currentCell)) return; const currentRow = currentCell.parentElement;
        if (currentRow.tagName !== 'TR') return; const isDataRow = tableBody.contains(currentRow); const container = isDataRow ? tableBody : tableHead;
        const rows = Array.from(container.querySelectorAll('tr')); const currentCellIndex = Array.from(currentRow.children).indexOf(currentCell); const currentRowIndex = rows.indexOf(currentRow); let nextCell; switch (e.key) { case 'ArrowUp': e.preventDefault();
        for (let i = currentRowIndex - 1; i >= 0; i--) { if (rows[i].children.length > 1) { nextCell = rows[i].children[currentCellIndex];
        break; } } break; case 'ArrowDown': e.preventDefault(); for (let i = currentRowIndex + 1; i < rows.length; i++) { if (rows[i].children.length > 1) { nextCell = rows[i].children[currentCellIndex];
        break; } } break; case 'ArrowLeft': e.preventDefault(); if (currentCellIndex > 0) nextCell = currentRow.children[currentCellIndex - 1]; break; case 'ArrowRight': e.preventDefault();
        if (currentCellIndex < currentRow.children.length - 1) nextCell = currentRow.children[currentCellIndex + 1]; break; default: return; } if (nextCell) nextCell.focus();
        }
        tableEl?.addEventListener('keydown', handleTableKeyDown);
        function exportToExcelCompatibleCsv(filename, rows) { if (!rows || rows.length === 0) { showNotification("ไม่มีข้อมูลสำหรับ Export"); return; } const header = Object.keys(rows[0]).join(',');
        const csvContent = rows.map(row => Object.values(row).map(value => { const strValue = String(value || ''); return strValue.includes(',') || strValue.includes('"') || strValue.includes('\n') ? `"${strValue.replace(/"/g, '""')}"` : strValue; }).join(',')).join('\n');
        const csv = `\uFEFF${header}\n${csvContent}`; const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a');
        if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        } }
        historyListContainer?.addEventListener('click', (e) => { const exportBtn = e.target.closest('.export-history-btn'); if (exportBtn) { const reqId = exportBtn.dataset.reqId; const historyItem = appState.historyList.find(item => item.id === reqId); if (historyItem) { exportToExcelCompatibleCsv(`${historyItem.requisitionNumber}.csv`, historyItem.items); } } });
        const navWrapper = document.getElementById('nav-toggle-wrapper'), navTrigger = document.getElementById('nav-trigger'), navIcon = document.getElementById('nav-trigger-icon'), navTabs = (navWrapper ? navWrapper.querySelector('nav') : null);
        let isNavOpen = false;
        const openNav = () => { if (isNavOpen) return; isNavOpen = true; navWrapper.classList.remove('h-4'); navWrapper.classList.add('h-16'); navIcon.classList.add('rotate-180'); };
        const closeNav = () => { if (!isNavOpen) return; isNavOpen = false; navWrapper.classList.remove('h-16'); navWrapper.classList.add('h-4'); navIcon.classList.remove('rotate-180'); };
        if (navTabs) { navTabs?.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { setTimeout(closeNav, 200); } });
        }
        if (window.matchMedia('(pointer: fine)').matches) { navWrapper?.addEventListener('mouseenter', openNav); navWrapper?.addEventListener('mouseleave', closeNav);
        } else { navTrigger?.addEventListener('click', () => isNavOpen ? closeNav() : openNav()); }
    });
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
  var nav = document.getElementById('nav-toggle-wrapper');
  if (nav) {
    nav.classList.remove('overflow-hidden');
    // normalize height classes
    Array.from(nav.classList).forEach(function(c){
      if (/^h-\d+$/.test(c)) nav.classList.remove(c);
    });
    nav.classList.add('h-14');
    nav.classList.add('lg:h-16');
    nav.classList.add('fixed','top-0','left-0','right-0','z-30');
  }
  var trigger = document.getElementById('nav-trigger');
  if (trigger && trigger.parentNode) {
    trigger.parentNode.removeChild(trigger);
  }
});
</script>
</body>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const navWrapper = document.getElementById('nav-toggle-wrapper');
    const navTrigger = document.getElementById('nav-trigger');
    const navIcon    = document.getElementById('nav-trigger-icon');
    const navTabs    = navWrapper ? navWrapper.querySelector('nav') : null;
    if (!navWrapper) return;
    let isNavOpen = false;
    const openNav = () => { if (isNavOpen) return; isNavOpen = true; navWrapper.classList.remove('h-4'); navWrapper.classList.add('h-16'); if (navIcon) navIcon.classList.add('rotate-180'); };
    const closeNav = () => { if (!isNavOpen) return; 
isNavOpen = false; navWrapper.classList.remove('h-16'); navWrapper.classList.add('h-4'); if (navIcon) navIcon.classList.remove('rotate-180'); };
    if (navTabs) navTabs?.addEventListener('click', e => { if (e.target && e.target.tagName === 'BUTTON') setTimeout(closeNav, 200);
});
    if (window.matchMedia && window.matchMedia('(pointer: fine)').matches) {
      navWrapper?.addEventListener('mouseenter', openNav);
      navWrapper?.addEventListener('mouseleave', closeNav);
} else if (navTrigger) {
      navTrigger?.addEventListener('click', () => isNavOpen ? closeNav() : openNav());
}
  });

  // Override confirmRequisition with a safer version
  window.confirmRequisition = async function confirmRequisition() {
    try {
      if (!window.requisitionListCollectionRef || !window.appState || !Array.isArray(window.appState.requisitionList) || window.appState.requisitionList.length === 0) return;
      const totalItems = window.appState.requisitionList.length;
      const totalQty = window.appState.requisitionList.reduce((s, it) => s + (parseInt(it.quantity, 10) || 0), 0);
      const reqNumber = await runTransaction(db, async (transaction) => {
        const counterSnap = await transaction.get(countersDocRef);
        const currentCounter = counterSnap.exists() ? (counterSnap.data().requisitionNumber || 0) : 0;
        const newCounter = currentCounter + 1;
        const now = new Date();
        const generatedReqNumber = `REQ-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}-${String(newCounter).padStart(4,'0')}`;
        const historyDocRef = doc(requisitionHistoryCollectionRef);
        transaction.set(historyDocRef, {
       
          requisitionNumber: generatedReqNumber,
          timestamp: (typeof Timestamp !== 'undefined' && Timestamp.now) ? Timestamp.now() : new Date(),
          items: window.appState.requisitionList.map(({ id, ...rest }) => rest),
          totalItems,
          totalQty
        });
        window.appState.requisitionList.forEach(item => transaction.delete(doc(requisitionListCollectionRef, item.id)));
        transaction.set(countersDocRef, { requisitionNumber: newCounter }, { merge: true });
        return generatedReqNumber;
      });
        if (reqNumber && window.appState.requisitionList.length > 0) {
    await sendLineMessage(reqNumber, window.appState.requisitionList);
}

      if (typeof showNotification === 'function') showNotification(`ยืนยันการเบิกของ ${reqNumber} เรียบร้อย`, false);
    } catch (error) {
      console.error("Transaction failed: ", error);
      if (typeof showError === 'function') showError("ยืนยันการเบิกของไม่สำเร็จ: " + error.message);
    }
  };
})();
</script>
</html>
