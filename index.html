<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลจาก Google Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .sortable-ghost {
            background-color: #c0e2ff;
            opacity: 0.7;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        #table-body tr, #category-list > div, #manage-category-list > div {
            cursor: grab;
        }
        #notification-toast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        #notification-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        #category-list::-webkit-scrollbar {
            height: 4px;
        }
        #category-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #category-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        #category-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #table-body tr[tabindex="0"]:focus {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: -2px;
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* --- CSS เพิ่มเติมสำหรับเส้นตาราง --- */
        .show-grid {
            border-collapse: collapse;
        }
        .show-grid th, .show-grid td {
           border: 1px solid #e5e7eb; /* Tailwind gray-200 */
        }
        /* --- จบส่วนที่เพิ่ม --- */

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="nav-toggle-wrapper" class="fixed top-0 left-0 right-0 z-30 h-4 bg-white shadow-md overflow-hidden transition-all duration-300 ease-in-out">
    <div class="container mx-auto lg:w-1/2 h-full relative">
        <div class="border-b border-gray-200">
            <nav class="flex justify-center -mb-px space-x-2" aria-label="Tabs">
                <button id="nav-products" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                    รายการสินค้า
                </button>
                <button id="nav-requisition" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    รายการเบิกของ
                </button>
                <button id="nav-history" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    ประวัติ
                </button>
                <button id="nav-manage" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    จัดการ
                </button>
                <button id="nav-account" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    บัญชี
                </button>
            </nav>
        </div>
        <div id="nav-trigger" class="absolute bottom-0 left-0 w-full h-4 bg-white cursor-pointer border-t border-gray-200 flex items-center justify-center">
            <svg id="nav-trigger-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </div>
</div>

<div class="container mx-auto px-2 py-4 pt-8 sm:p-6 md:p-8 lg:w-1/2 pb-24">
    
    <div id="auth-container" class="mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <form id="login-form">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">เข้าสู่ระบบ</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">เข้าสู่ระบบ</button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <p class="text-sm text-center text-gray-600 mt-4">
                    ยังไม่มีบัญชี? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">สมัครสมาชิกที่นี่</button>
                </p>
            </form>

            <form id="register-form" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">สมัครสมาชิกใหม่</h2>
                 <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                    <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">สมัครสมาชิก</button>
                <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <p class="text-sm text-center text-gray-600 mt-4">
                    มีบัญชีอยู่แล้ว? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">เข้าสู่ระบบที่นี่</button>
                </p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <div id="product-list-view">
            <div id="data-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                <div id="loading" class="p-8 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
                </div>
                <div id="error" class="hidden p-8 text-center text-red-600 bg-red-50 rounded-lg">
                    <h3 class="font-bold text-lg">เกิดข้อผิดพลาด</h3>
                    <p id="error-message" class="mt-2">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="data-table" class="hidden w-full min-w-full table-auto show-grid">
                        <thead id="table-head" class="bg-gray-50"></thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="no-data" class="hidden p-8 text-center text-gray-500">
                    <p>ไม่พบข้อมูล</p>
                </div>
            </div>
        </div>

        <div id="requisition-view" class="hidden">
                 <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                      <div class="flex justify-between items-center mb-4">
                          <h2 class="text-2xl font-bold text-gray-700">รายการเบิกของ</h2>
                          <div class="flex items-center gap-2">
                              <button id="auto-requisition-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                  เบิกของอัตโนมัติ
                              </button>
                              <button id="confirm-requisition-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 disabled:bg-gray-400">
                                  ยืนยัน
                              </button>
                          </div>
                      </div>
                      <div class="overflow-x-auto">
                          <table class="w-full min-w-full divide-y divide-gray-200 show-grid">
                              <thead class="bg-gray-200">
                                  <tr>
                                      <th class="py-3 px-2 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-8">ลำดับ</th>
                                      <th class="py-3 px-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider w-auto">สินค้า</th>
                                      <th class="py-3 px-2 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-14">จำนวนเบิก</th>
                                      <th class="py-3 px-2 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-14">หน่วย</th>
                                      <th class="py-3 px-2 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-12">จัดการ</th>
                                  </tr>
                              </thead>
                              <tbody id="requisition-list-body" class="bg-white divide-y divide-gray-200">
                              </tbody>
                          </table>
                      </div>
                </div>
        </div>

         <div id="history-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">ประวัติการเบิกของ</h2>
                <div id="history-list-container" class="space-y-6">
                </div>
            </div>
        </div>

        <div id="manage-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 space-y-8">
                <div>
                    <h2 class="text-xl font-bold text-gray-700 mb-4">เพิ่มหมวดหมู่ใหม่</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="category-input" placeholder="ใส่ชื่อหมวดหมู่ที่นี่..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-category-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            เพิ่มหมวดหมู่
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-700 mb-4">จัดการหมวดหมู่ที่มีอยู่</h2>
                    <p class="text-sm text-gray-500 mb-2">ดับเบิ้ลคลิกที่ชื่อหมวดหมู่เพื่อแก้ไขหรือลบ</p>
                    <div id="manage-category-list" class="flex flex-wrap gap-2 items-center">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="account-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">ลงชื่อเข้าใช้ในชื่อ:</p>
                        <p id="user-email" class="font-semibold text-gray-800"></p>
                    </div>
                    <div class="flex items-center gap-2">
                         <button id="app-settings-btn" title="ตั้งค่า" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-blue-600 transition-colors">
                             <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                             </svg>
                         </button>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-gray-400 text-sm">
        <p>สร้างโดย Gemini</p>
    </footer>
</div>

<div id="category-nav-view" class="hidden fixed bottom-0 left-0 right-0 z-20 bg-white shadow-[0_-2px_10px_-3px_rgba(0,0,0,0.1)] border-t border-gray-200">
    <div class="container mx-auto lg:w-1/2">
        <nav id="category-list" class="flex gap-x-2 px-2 overflow-x-auto" aria-label="Category Tabs">
        </nav>
    </div>
</div>

<div id="item-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-item-name">ตั้งค่าสินค้า</h3>
            <div class="mt-4 px-7 py-3 space-y-4 text-left">
                <div>
                    <label for="reorder-point" class="block text-sm font-medium text-gray-700">จุดเบิกของ (Reorder Point)</label>
                    <input type="number" id="reorder-point" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น 10">
                </div>
                <div>
                    <label for="reorder-quantity" class="block text-sm font-medium text-gray-700">จำนวนเบิกอัตโนมัติ</label>
                    <input type="number" id="reorder-quantity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น 50">
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    ตกลง
                </button>
                <button id="modal-cancel-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="category-actions-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="category-modal-name">จัดการหมวดหมู่</h3>
            <div class="mt-6 space-y-3">
                <button id="edit-category-btn" class="w-full px-4 py-3 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                    </svg>
                    แก้ไขชื่อหมวดหมู่
                </button>
                <button id="delete-category-btn" class="w-full px-4 py-3 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    ลบหมวดหมู่
                </button>
            </div>
            <div class="mt-6">
                <button id="category-modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="add-header-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">เพิ่มหัวข้อใหม่</h3>
            <div class="mt-4 px-7 py-3">
                <input type="text" id="header-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="ใส่ชื่อหัวข้อที่นี่...">
            </div>
            <div class="items-center px-4 py-3">
                <button id="header-modal-ok-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    เพิ่มหัวข้อ
                </button>
                <button id="header-modal-cancel-btn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="header-actions-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="header-modal-name">จัดการหัวข้อ</h3>
            <div class="mt-6 space-y-3">
                <button id="edit-header-btn" class="w-full px-4 py-3 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                    แก้ไขหัวข้อ
                </button>
                <button id="delete-header-btn" class="w-full px-4 py-3 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    ลบหัวข้อ
                </button>
            </div>
            <div class="mt-6">
                <button id="header-actions-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="app-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-40">
    <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-xl text-center leading-6 font-medium text-gray-900">ตั้งค่าการเบิกของอัตโนมัติ</h3>
             <div class="mt-4 px-7 py-3 space-y-4 text-left">
                <div>
                    <label for="setting-trigger-col" class="block text-sm font-medium text-gray-700">คอลัมน์ตรวจสอบสต็อก</label>
                    <input type="text" id="setting-trigger-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ใช้ตรวจสอบว่าสต็อกถึงจุดที่ต้องเบิกหรือไม่</p>
                </div>
                 <div>
                    <label for="setting-calc-col" class="block text-sm font-medium text-gray-700">คอลัมน์คำนวณจำนวน</label>
                    <input type="text" id="setting-calc-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ใช้ในการคำนวณปริมาณเบิก (ถ้ามี)</p>
                </div>
                 <div>
                    <label for="setting-unit-col" class="block text-sm font-medium text-gray-700">คอลัมน์หน่วยนับ</label>
                    <input type="text" id="setting-unit-col" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-500">ชื่อคอลัมน์ที่ระบุหน่วยของสินค้า</p>
                </div>
            </div>
            <div class="items-center px-4 py-3 sm:flex">
                 <button id="app-settings-save-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                     บันทึก
                 </button>
                 <button id="app-settings-cancel-btn" class="mt-3 sm:mt-0 sm:ml-3 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                     ยกเลิก
                 </button>
            </div>
        </div>
    </div>
</div>

<div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
    <div class="relative mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="confirm-modal-title">ยืนยันการลบ</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="confirm-modal-body">คุณแน่ใจหรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            </div>
            <div class="items-center px-4 py-3 sm:flex">
                <button id="confirm-modal-ok-btn" class="w-full sm:w-auto px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                    ยืนยัน
                </button>
                <button id="confirm-modal-cancel-btn" class="mt-3 sm:mt-0 sm:ml-3 w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
</div>

<div id="notification-toast" class="hidden opacity-0 fixed top-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg z-50">
    <p id="notification-message"></p>
</div>

<div id="item-context-menu" class="hidden fixed z-40 bg-white shadow-lg rounded-md ring-1 ring-black ring-opacity-5 focus:outline-none w-48">
    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
        <button id="context-menu-settings" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span>ตั้งค่าสินค้า</span>
        </button>
        <button id="context-menu-hide" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-2.14 2.14" /></svg>
            <span>ซ่อนแถวสินค้า</span>
        </button>
        <div class="border-t border-gray-100 my-1"></div>
        <button id="context-menu-add-header" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center gap-3" role="menuitem">
            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z"></path></svg>
            <span>เพิ่มหัวข้อใหม่</span>
        </button>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel, getDocs, setDoc, getDoc, Timestamp, writeBatch, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        const sheetUrl = 'https://script.google.com/macros/s/AKfycbyW37lyYs-WKqsSyoG8PO2emr3bH1J0CnkNWKnZ409-y43qo-hbOy9UFO6L3dnSP8FlHg/exec';

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const loginErrorEl = document.getElementById('login-error');
        const registerErrorEl = document.getElementById('register-error');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const noDataEl = document.getElementById('no-data');
        const tableEl = document.getElementById('data-table');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const categoryInput = document.getElementById('category-input');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryList = document.getElementById('category-list');
        const manageCategoryList = document.getElementById('manage-category-list');
        const navProductsBtn = document.getElementById('nav-products');
        const navRequisitionBtn = document.getElementById('nav-requisition');
        const navHistoryBtn = document.getElementById('nav-history');
        const navManageBtn = document.getElementById('nav-manage');
        const navAccountBtn = document.getElementById('nav-account');
        const productListView = document.getElementById('product-list-view');
        const requisitionView = document.getElementById('requisition-view');
        const historyView = document.getElementById('history-view');
        const manageView = document.getElementById('manage-view');
        const accountView = document.getElementById('account-view');
        const categoryNavView = document.getElementById('category-nav-view');
        const autoRequisitionBtn = document.getElementById('auto-requisition-btn');
        const requisitionListBody = document.getElementById('requisition-list-body');
        const confirmRequisitionBtn = document.getElementById('confirm-requisition-btn');
        const historyListContainer = document.getElementById('history-list-container');
        const itemSettingsModal = document.getElementById('item-settings-modal');
        const modalItemName = document.getElementById('modal-item-name');
        const reorderPointInput = document.getElementById('reorder-point');
        const reorderQuantityInput = document.getElementById('reorder-quantity');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const categoryActionsModal = document.getElementById('category-actions-modal');
        const categoryModalName = document.getElementById('category-modal-name');
        const editCategoryBtn = document.getElementById('edit-category-btn');
        const deleteCategoryBtn = document.getElementById('delete-category-btn');
        const categoryModalCancelBtn = document.getElementById('category-modal-cancel-btn');
        const addHeaderModal = document.getElementById('add-header-modal');
        const headerInput = document.getElementById('header-input');
        const headerModalOkBtn = document.getElementById('header-modal-ok-btn');
        const headerModalCancelBtn = document.getElementById('header-modal-cancel-btn');
        const headerActionsModal = document.getElementById('header-actions-modal');
        const headerModalName = document.getElementById('header-modal-name');
        const editHeaderBtn = document.getElementById('edit-header-btn');
        const deleteHeaderBtn = document.getElementById('delete-header-btn');
        const headerActionsCancelBtn = document.getElementById('header-actions-cancel-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const appSettingsModal = document.getElementById('app-settings-modal');
        const appSettingsBtn = document.getElementById('app-settings-btn');
        const appSettingsSaveBtn = document.getElementById('app-settings-save-btn');
        const appSettingsCancelBtn = document.getElementById('app-settings-cancel-btn');
        const settingTriggerColInput = document.getElementById('setting-trigger-col');
        const settingCalcColInput = document.getElementById('setting-calc-col');
        const settingUnitColInput = document.getElementById('setting-unit-col');
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const itemContextMenu = document.getElementById('item-context-menu');
        const contextMenuSettingsBtn = document.getElementById('context-menu-settings');
        const contextMenuHideBtn = document.getElementById('context-menu-hide');
        const contextMenuAddHeaderBtn = document.getElementById('context-menu-add-header'); // [NEW]
        
        let allRecords = [], currentRecords = [], categories = [], sortOrdersMap = {}, categoryOrder = [], requisitionList = [], historyList = [];
        let customRows = new Map(), itemSettings = new Map(), hiddenItemsMap = {};
        let itemColumnName = '', activeCategoryName = null, currentEditingItemId = null, currentEditingCategory = null, currentEditingHeaderId = null, currentEditingHeaderText = null, confirmCallback = null, notificationTimeout = null, insertHeaderAboveId = null;
        let contextMenuItemRecord = null;
        let sortableInstance = null, categorySortableInstance = null;
        let appSettings = { triggerStockColumnName: 'รักษ์ยา', calculationStockColumnName: 'เบบี้ช็อป', unitColumnName: 'หน่วย' };
        let resolveCategoriesLoaded, categoriesFirstLoad = true;
        const categoriesLoadedPromise = new Promise(resolve => { resolveCategoriesLoaded = resolve; });
        let userId = null;
        let categoriesCollectionRef, hiddenItemsDocRef, sortOrdersDocRef, customRowsCollectionRef, categoryOrderDocRef, itemSettingsCollectionRef, requisitionListCollectionRef, requisitionHistoryCollectionRef, countersDocRef, appSettingsDocRef;
        let unsubscribes = [];

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY", authDomain: "pos-6-23035.firebaseapp.com", projectId: "pos-6-23035", storageBucket: "pos-6-23035.appspot.com", messagingSenderId: "1025982856125", appId: "1:1025982856125:web:28e47483570949900f30d4" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.querySelectorAll('#user-email').forEach(el => el.textContent = user.email);
                initializeListeners(userId);
                switchView('products');
                if(allRecords.length === 0) fetchData(); 
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                unsubscribes.forEach(unsub => unsub && unsub());
                unsubscribes = [];
                categories = []; hiddenItemsMap = {}; sortOrdersMap = {}; categoryOrder = []; customRows.clear(); itemSettings.clear(); requisitionList = []; historyList = [];
                displayCategories(); 
            }
        });
        
        function initializeListeners(currentUserId) {
                 if (!currentUserId) return;
                 unsubscribes.forEach(unsub => unsub && unsub());
                 unsubscribes = [];
                 const userPath = `artifacts/${appId}/users/${currentUserId}`;
                 categoriesCollectionRef = collection(db, `${userPath}/categories`);
                 hiddenItemsDocRef = doc(db, `${userPath}/settings`, 'hiddenItemsByCategory');
                 sortOrdersDocRef = doc(db, `${userPath}/settings`, 'sortOrders');
                 customRowsCollectionRef = collection(db, `${userPath}/customRows`);
                 categoryOrderDocRef = doc(db, `${userPath}/settings`, 'categoryOrder');
                 itemSettingsCollectionRef = collection(db, `${userPath}/itemSettings`);
                 requisitionListCollectionRef = collection(db, `${userPath}/requisitionList`);
                 requisitionHistoryCollectionRef = collection(db, `${userPath}/requisitionHistory`);
                 countersDocRef = doc(db, `${userPath}/settings`, 'counters');
                 appSettingsDocRef = doc(db, `${userPath}/settings`, 'appSettings');
                 unsubscribes.push(onSnapshot(categoriesCollectionRef, (snap) => {
                     const fetchedCategories = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     if (userId && !fetchedCategories.some(c => c.name === 'อื่นๆ') && !snap.metadata.hasPendingWrites) {
                         addDoc(categoriesCollectionRef, { name: 'อื่นๆ' }).catch(err => console.error("Could not create 'อื่นๆ' category", err));
                     } else {
                         categories = fetchedCategories;
                         displayCategories();
                         if (categoriesFirstLoad && resolveCategoriesLoaded) { categoriesFirstLoad = false; resolveCategoriesLoaded(); }
                     }
                 }, (err) => showError("โหลดหมวดหมู่ไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(hiddenItemsDocRef, (docSnap) => {
                     const data = docSnap.exists() ? docSnap.data() : {};
                     hiddenItemsMap = {}; 
                     for (const categoryName in data) { if (Array.isArray(data[categoryName])) { hiddenItemsMap[categoryName] = new Set(data[categoryName]); } }
                     if (allRecords.length > 0) { displayData(currentRecords); }
                 }, (err) => showError("โหลดรายการที่ซ่อนไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(sortOrdersDocRef, (snap) => { sortOrdersMap = (snap.exists() && snap.data().orders) ? snap.data().orders : {}; if (allRecords.length > 0) displayData(currentRecords); }, (err) => showError("โหลดลำดับจัดเรียงไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(categoryOrderDocRef, (snap) => { categoryOrder = (snap.exists() && snap.data().order) ? snap.data().order : []; if (categories.length > 0) displayCategories(); }, (err) => showError("โหลดลำดับหมวดหมู่ไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(customRowsCollectionRef, (snap) => { customRows.clear(); snap.docs.forEach(doc => customRows.set(doc.id, doc.data())); if (allRecords.length > 0) displayData(currentRecords); }, (err) => showError("โหลดหัวข้อไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(itemSettingsCollectionRef, (snap) => { itemSettings.clear(); snap.docs.forEach(doc => itemSettings.set(doc.id, doc.data())); }, (err) => showError("โหลดการตั้งค่าสินค้าไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(requisitionListCollectionRef, (snap) => { requisitionList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); displayRequisitionList(); }, (err) => showError("โหลดรายการเบิกของไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(requisitionHistoryCollectionRef, (snap) => { historyList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds); displayHistory(); }, (err) => showError("โหลดประวัติไม่สำเร็จ")));
                 unsubscribes.push(onSnapshot(appSettingsDocRef, (snap) => { if (snap.exists()) { appSettings = { ...appSettings, ...snap.data() }; } updateAppSettingsModalInputs(); }, (err) => showError("โหลดการตั้งค่าแอปไม่สำเร็จ")));
        }

        showRegisterBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        showLoginBtn.addEventListener('click', () => { registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); loginErrorEl.textContent = ''; try { await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value); } catch (error) { loginErrorEl.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง"; } });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); registerErrorEl.textContent = ''; try { await createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value); } catch (error) { if (error.code === 'auth/weak-password') registerErrorEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร'; else if (error.code === 'auth/email-already-in-use') registerErrorEl.textContent = 'อีเมลนี้ถูกใช้งานแล้ว'; else registerErrorEl.textContent = 'เกิดข้อผิดพลาดในการสมัคร'; } });
        logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); } });
        
        async function saveCurrentSortOrder(newOrder) { if (!sortOrdersDocRef) return; const key = activeCategoryName || '__global__'; try { const docSnap = await getDoc(sortOrdersDocRef); const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {}; currentOrders[key] = newOrder; await setDoc(sortOrdersDocRef, { orders: currentOrders }); } catch (error) { showError("บันทึกการจัดเรียงไม่สำเร็จ"); } }
        async function saveCategoryOrder(newOrder) { if (!categoryOrderDocRef) return; try { await setDoc(categoryOrderDocRef, { order: newOrder }); } catch (error) { showError("บันทึกการจัดเรียงหมวดหมู่ไม่สำเร็จ"); } }
        
        async function hideItem(itemId) { if (!hiddenItemsDocRef || !itemId) return; const categoryKey = activeCategoryName || '__global__'; try { await updateDoc(hiddenItemsDocRef, { [categoryKey]: arrayUnion(itemId) }); } catch (e) { if (e.code === 'not-found') { try { await setDoc(hiddenItemsDocRef, { [categoryKey]: [itemId] }); } catch (setErr) { showError("ซ่อนรายการไม่สำเร็จ"); } } else { showError("ซ่อนรายการไม่สำเร็จ"); } } }
        async function unhideItems(idsToUnhide) { if (!hiddenItemsDocRef || !idsToUnhide || idsToUnhide.length === 0) return; const categoryKey = activeCategoryName || '__
