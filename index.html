<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลจาก Google Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap">
    <!-- SortableJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .sortable-ghost {
            background-color: #c0e2ff;
            opacity: 0.7;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        #table-body tr, #category-list > div {
            cursor: grab;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 lg:w-1/2">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">ตารางแสดงข้อมูล</h1>
            <p class="text-gray-500 mt-2">ข้อมูลล่าสุดจาก Google Sheet</p>
        </header>

        <!-- Auth Container -->
        <div id="auth-container" class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <!-- Login Form -->
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">เข้าสู่ระบบ</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">เข้าสู่ระบบ</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    <p class="text-sm text-center text-gray-600 mt-4">
                        ยังไม่มีบัญชี? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">สมัครสมาชิกที่นี่</button>
                    </p>
                </form>

                <!-- Registration Form -->
                <form id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">สมัครสมาชิกใหม่</h2>
                     <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">สมัครสมาชิก</button>
                    <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    <p class="text-sm text-center text-gray-600 mt-4">
                        มีบัญชีอยู่แล้ว? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">เข้าสู่ระบบที่นี่</button>
                    </p>
                </form>
            </div>
        </div>


        <!-- App Container (Hidden by default) -->
        <div id="app-container" class="hidden">
            <!-- User Info and Logout -->
            <div class="mb-8 bg-white rounded-lg shadow-md p-4 flex justify-between items-center">
                <div>
                     <p class="text-sm text-gray-500">ลงชื่อเข้าใช้ในชื่อ:</p>
                     <p id="user-email" class="font-semibold text-gray-800"></p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">ออกจากระบบ</button>
            </div>
            
            <!-- Category Management Section -->
            <div class="mb-8 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">จัดการหมวดหมู่และหัวข้อ</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="category-input" placeholder="ใส่ชื่อหมวดหมู่ที่นี่..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-category-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        เพิ่มหมวดหมู่
                    </button>
                     <button id="add-header-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        เพิ่มหัวข้อ
                    </button>
                </div>
                <div id="category-list-container">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">หมวดหมู่ของฉัน:</h3>
                    <p class="text-sm text-gray-500 mb-2">คลิกที่ชื่อหมวดหมู่เพื่อกรองข้อมูล</p>
                    <div id="category-list" class="flex flex-wrap gap-2 items-center">
                        <!-- Categories will be injected here by JavaScript -->
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button id="clear-filter-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            แสดงทั้งหมด
                        </button>
                        <button id="show-hidden-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                            แสดงแถวที่ซ่อน
                        </button>
                    </div>
                </div>
            </div>

            <!-- Container for the table and loading/error states -->
            <div id="data-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                
                <!-- Loading State -->
                <div id="loading" class="p-8 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
                </div>

                <!-- Error State -->
                <div id="error" class="hidden p-8 text-center text-red-600 bg-red-50 rounded-lg">
                    <h3 class="font-bold text-lg">เกิดข้อผิดพลาด</h3>
                    <p id="error-message" class="mt-2">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>
                </div>

                <!-- Table will be inserted here -->
                <div class="overflow-x-auto">
                    <table id="data-table" class="hidden w-full min-w-full divide-y divide-gray-200">
                        <thead id="table-head" class="bg-gray-50">
                            <!-- Header row will be generated by JavaScript -->
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- No data state -->
                <div id="no-data" class="hidden p-8 text-center text-gray-500">
                    <p>ไม่พบข้อมูล</p>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-gray-400 text-sm">
            <p>สร้างโดย Gemini</p>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const sheetUrl = 'https://script.google.com/macros/s/AKfycbyW37lyYs-WKqsSyoG8PO2emr3bH1J0CnkNWKnZ409-y43qo-hbOy9UFO6L3dnSP8FlHg/exec';

            // DOM Elements
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const loginErrorEl = document.getElementById('login-error');
            const registerErrorEl = document.getElementById('register-error');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const userEmailEl = document.getElementById('user-email');
            const logoutBtn = document.getElementById('logout-btn');

            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const errorMessageEl = document.getElementById('error-message');
            const noDataEl = document.getElementById('no-data');
            const tableEl = document.getElementById('data-table');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            const categoryInput = document.getElementById('category-input');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const addHeaderBtn = document.getElementById('add-header-btn');
            const categoryList = document.getElementById('category-list');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const showHiddenBtn = document.getElementById('show-hidden-btn');
            
            // App State
            let allRecords = [];
            let currentRecords = [];
            let categories = []; 
            let customRows = new Map();
            let itemColumnName = '';
            let hiddenItemIds = new Set();
            let sortableInstance = null;
            let categorySortableInstance = null;
            let sortOrdersMap = {};
            let categoryOrder = [];
            let activeCategoryName = null;
            
            // Firebase State
            let userId = null;
            let categoriesCollectionRef;
            let unsubscribeCategories;
            let hiddenItemsCollectionRef;
            let unsubscribeHiddenItems;
            let sortOrdersDocRef;
            let unsubscribeSortOrders;
            let customRowsCollectionRef;
            let unsubscribeCustomRows;
            let categoryOrderDocRef;
            let unsubscribeCategoryOrder;


            // Firebase Config
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = {
              apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY",
              authDomain: "pos-6-23035.firebaseapp.com",
              projectId: "pos-6-23035",
              storageBucket: "pos-6-23035.appspot.com",
              messagingSenderId: "1025982856125",
              appId: "1:1025982856125:web:28e47483570949900f30d4"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug');

            // --- Auth State Management ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    userEmailEl.textContent = user.email;
                    initializeListeners(userId);
                    if(allRecords.length === 0) fetchData(); 
                } else {
                    userId = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    if (unsubscribeCategories) unsubscribeCategories();
                    if (unsubscribeHiddenItems) unsubscribeHiddenItems();
                    if (unsubscribeSortOrders) unsubscribeSortOrders();
                    if (unsubscribeCustomRows) unsubscribeCustomRows();
                    if (unsubscribeCategoryOrder) unsubscribeCategoryOrder();
                    categories = [];
                    hiddenItemIds.clear();
                    sortOrdersMap = {};
                    categoryOrder = [];
                    customRows.clear();
                    displayCategories(); 
                }
            });
            
            function initializeListeners(currentUserId) {
                 if (!currentUserId) return;
                 initializeCategoryListener(currentUserId);
                 initializeHiddenItemsListener(currentUserId);
                 initializeSortOrdersListener(currentUserId);
                 initializeCustomRowsListener(currentUserId);
                 initializeCategoryOrderListener(currentUserId);
            }

            // --- Auth UI Toggling & Event Handlers ---
            showRegisterBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });
            showLoginBtn.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginErrorEl.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value);
                } catch (error) { loginErrorEl.textContent = "อีเมลหรือรหัสผ่านไม่ถูกต้อง"; }
            });
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                registerErrorEl.textContent = '';
                try {
                    await createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value);
                } catch (error) {
                    if (error.code === 'auth/weak-password') registerErrorEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                    else if (error.code === 'auth/email-already-in-use') registerErrorEl.textContent = 'อีเมลนี้ถูกใช้งานแล้ว';
                    else if (error.code === 'auth/operation-not-allowed') registerErrorEl.textContent = 'การสมัครด้วยอีเมลยังไม่ถูกเปิดใช้งานในระบบ';
                    else registerErrorEl.textContent = 'เกิดข้อผิดพลาดในการสมัคร';
                }
            });
            logoutBtn.addEventListener('click', async () => {
                try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); }
            });
            
            // --- Firestore Listeners ---
            function initializeCategoryListener(currentUserId) {
                if (unsubscribeCategories) unsubscribeCategories();
                categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
                unsubscribeCategories = onSnapshot(categoriesCollectionRef, (snapshot) => {
                    categories = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                    displayCategories();
                }, (error) => showError("ไม่สามารถโหลดหมวดหมู่ได้"));
            }
            function initializeHiddenItemsListener(currentUserId) {
                if (unsubscribeHiddenItems) unsubscribeHiddenItems();
                hiddenItemsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/hiddenItems`);
                unsubscribeHiddenItems = onSnapshot(hiddenItemsCollectionRef, (snapshot) => {
                    hiddenItemIds = new Set(snapshot.docs.map(doc => doc.id));
                    if (allRecords.length > 0) displayData(currentRecords);
                    updateShowHiddenButtonVisibility();
                }, (error) => showError("ไม่สามารถโหลดรายการที่ซ่อนได้"));
            }
            function initializeSortOrdersListener(currentUserId) {
                if (unsubscribeSortOrders) unsubscribeSortOrders();
                sortOrdersDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, 'sortOrders');
                unsubscribeSortOrders = onSnapshot(sortOrdersDocRef, (docSnap) => {
                    sortOrdersMap = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {};
                    if (allRecords.length > 0) displayData(currentRecords);
                }, (error) => showError("ไม่สามารถโหลดลำดับการจัดเรียงได้"));
            }
            function initializeCategoryOrderListener(currentUserId) {
                if (unsubscribeCategoryOrder) unsubscribeCategoryOrder();
                categoryOrderDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, 'categoryOrder');
                unsubscribeCategoryOrder = onSnapshot(categoryOrderDocRef, (docSnap) => {
                    categoryOrder = (docSnap.exists() && docSnap.data().order) ? docSnap.data().order : [];
                    if (categories.length > 0) displayCategories();
                }, (error) => showError("ไม่สามารถโหลดลำดับหมวดหมู่ได้"));
            }
            function initializeCustomRowsListener(currentUserId) {
                if(unsubscribeCustomRows) unsubscribeCustomRows();
                customRowsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/customRows`);
                unsubscribeCustomRows = onSnapshot(customRowsCollectionRef, (snapshot) => {
                    customRows.clear();
                    snapshot.docs.forEach(doc => customRows.set(doc.id, doc.data()));
                    if (allRecords.length > 0) displayData(currentRecords);
                }, (error) => showError("ไม่สามารถโหลดหัวข้อได้"));
            }


            // --- Firestore Write Functions (Robust Read-Modify-Write) ---
            async function saveCurrentSortOrder(newOrder) {
                if (!sortOrdersDocRef) return;
                const key = activeCategoryName || '__global__';
                try {
                    const docSnap = await getDoc(sortOrdersDocRef);
                    const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {};
                    currentOrders[key] = newOrder;
                    await setDoc(sortOrdersDocRef, { orders: currentOrders });
                } catch (error) {
                    showError("ไม่สามารถบันทึกลำดับการจัดเรียงได้: " + error.message);
                }
            }
            async function saveCategoryOrder(newOrder) {
                if (!categoryOrderDocRef) return;
                try { await setDoc(categoryOrderDocRef, { order: newOrder }); } 
                catch (error) { showError("ไม่สามารถบันทึกลำดับหมวดหมู่ได้"); }
            }
            async function hideItem(itemId) {
                if (!hiddenItemsCollectionRef || !itemId) return;
                try { await setDoc(doc(hiddenItemsCollectionRef, itemId), { hidden: true }); } 
                catch (error) { showError("ไม่สามารถซ่อนรายการได้"); }
            }
            async function unhideItems(itemIdsToUnhide) {
                if (!hiddenItemsCollectionRef || !itemIdsToUnhide || itemIdsToUnhide.length === 0) return;
                try {
                    await Promise.all(itemIdsToUnhide.map(id => deleteDoc(doc(hiddenItemsCollectionRef, id))));
                } catch (error) { showError("ไม่สามารถแสดงรายการที่ซ่อนได้"); }
            }
            async function addCategory() {
                if (!categoriesCollectionRef) return;
                const name = categoryInput.value.trim();
                if (name && !categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                    try { await addDoc(categoriesCollectionRef, { name }); categoryInput.value = ''; } 
                    catch(error) { showError("ไม่สามารถเพิ่มหมวดหมู่ได้"); }
                } else if (name) alert('มีหมวดหมู่นี้อยู่แล้ว');
            }
            async function editCategory(id, oldName) {
                if (!categoriesCollectionRef) return;
                const newName = prompt('แก้ไขชื่อหมวดหมู่:', oldName);
                if (newName && newName.trim() && newName.trim() !== oldName) {
                    try { await updateDoc(doc(categoriesCollectionRef, id), { name: newName.trim() }); } 
                    catch(error) { showError("ไม่สามารถแก้ไขหมวดหมู่ได้"); }
                }
            }
            async function deleteCategory(id) {
                if (!categoriesCollectionRef) return;
                try {
                    await deleteDoc(doc(categoriesCollectionRef, id));
                    displayData(allRecords); 
                    clearFilterBtn.classList.add('hidden');
                } catch(error) { showError("ไม่สามารถลบหมวดหมู่ได้"); }
            }
            async function addHeaderRow() {
                const text = prompt("ใส่ชื่อหัวข้อ:");
                if (!text || !text.trim()) return;
                try {
                    const key = activeCategoryName || '__global__';
                    
                    const newDocRef = await addDoc(customRowsCollectionRef, { 
                        text: text.trim(),
                        categoryName: activeCategoryName 
                    });
                    
                    const docSnap = await getDoc(sortOrdersDocRef);
                    const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {};
                    const currentCategoryOrder = currentOrders[key] || [];
                    currentOrders[key] = [newDocRef.id, ...currentCategoryOrder];

                    await setDoc(sortOrdersDocRef, { orders: currentOrders });
                } catch(error) { showError("ไม่สามารถเพิ่มหัวข้อได้: " + error.message); }
            }
            async function editHeaderRow(id, oldText) {
                const newText = prompt("แก้ไขชื่อหัวข้อ:", oldText);
                if (newText && newText.trim() && newText.trim() !== oldText) {
                    try { await updateDoc(doc(customRowsCollectionRef, id), { text: newText.trim() }); } 
                    catch (error) { showError("ไม่สามารถแก้ไขหัวข้อได้"); }
                }
            }
            async function deleteHeaderRow(id) {
                if (!customRowsCollectionRef || !sortOrdersDocRef) return;
                try {
                    const key = activeCategoryName || '__global__';
                    
                    const docSnap = await getDoc(sortOrdersDocRef);
                    const currentOrders = (docSnap.exists() && docSnap.data().orders) ? docSnap.data().orders : {};
                    const currentCategoryOrder = currentOrders[key] || [];
                    currentOrders[key] = currentCategoryOrder.filter(itemId => itemId !== id);

                    await setDoc(sortOrdersDocRef, { orders: currentOrders });
                    await deleteDoc(doc(customRowsCollectionRef, id));
                } catch (error) { showError("ไม่สามารถลบหัวข้อได้: " + error.message); }
            }


            // --- UI Display Functions ---
            function displayCategories() {
                if (categorySortableInstance) categorySortableInstance.destroy();
                categoryList.innerHTML = '';
                if (!userId) return;

                if (categories.length === 0) {
                    categoryList.innerHTML = '<p class="text-gray-500 text-sm">ยังไม่มีหมวดหมู่ที่บันทึกไว้</p>';
                    return;
                }
                
                const sortedCategories = [...categories].sort((a, b) => {
                    const indexA = categoryOrder.indexOf(a.id);
                    const indexB = categoryOrder.indexOf(b.id);
                    if (indexA === -1 && indexB === -1) return a.name.localeCompare(b.name, 'th');
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                sortedCategories.forEach((category) => {
                    const categoryEl = document.createElement('div');
                    categoryEl.dataset.id = category.id;
                    categoryEl.className = 'flex items-center bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 transition-shadow duration-200';
                    const nameBtn = document.createElement('button');
                    nameBtn.textContent = category.name;
                    nameBtn.className = 'focus:outline-none';
                    nameBtn.title = `กรองด้วย "${category.name}"`;
                    nameBtn.onclick = () => {
                        if (!itemColumnName) return;
                        const filtered = allRecords.filter(r => r[itemColumnName]?.toLowerCase().includes(category.name.toLowerCase()));
                        noDataEl.querySelector('p').textContent = `ไม่พบสินค้าในหมวดหมู่ "${category.name}"`;
                        activeCategoryName = category.name;
                        displayData(filtered);
                        clearFilterBtn.classList.remove('hidden');
                        document.querySelectorAll('#category-list > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                        categoryEl.classList.add('ring-2', 'ring-blue-500');
                    };
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>`;
                    editBtn.className = 'ml-2 text-gray-500 hover:text-blue-600 focus:outline-none';
                    editBtn.onclick = () => editCategory(category.id, category.name);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    deleteBtn.className = 'ml-1 text-gray-500 hover:text-red-600 focus:outline-none';
                    deleteBtn.onclick = () => deleteCategory(category.id);
                    categoryEl.append(nameBtn, editBtn, deleteBtn);
                    categoryList.appendChild(categoryEl);
                });

                categorySortableInstance = new Sortable(categoryList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    delay: 200,
                    delayOnTouchOnly: true,
                    touchStartThreshold: 5,
                    onEnd: (evt) => {
                        const newOrder = Array.from(categoryList.querySelectorAll('div')).map(el => el.dataset.id);
                        saveCategoryOrder(newOrder);
                    }
                });
            }

            // --- Data Fetching and Main Display Logic ---
            async function fetchData() {
                try {
                    loadingEl.classList.remove('hidden');
                    const response = await fetch(sheetUrl);
                    if (!response.ok) throw new Error(`Network: ${response.statusText}`);
                    const data = await response.json();
                    if (!Array.isArray(data.data) || data.data.length === 0) { showNoData(); return; }
                    allRecords = data.data;
                    itemColumnName = Object.keys(allRecords[0])[0] || '';
                    if (!itemColumnName) { showError("ข้อมูลไม่มีคอลลัมน์"); return; }
                    displayData(allRecords);
                } catch (error) { showError(error.message); } 
                finally { loadingEl.classList.add('hidden'); }
            }
            
            function displayData(records) {
                currentRecords = records; 
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                if (sortableInstance) sortableInstance.destroy();

                const allRecordsMap = new Map(allRecords.map(r => [r[itemColumnName], r]));
                const currentRecordIds = new Set(records.map(r => r[itemColumnName]));

                const sortKey = activeCategoryName || '__global__';
                const currentItemOrder = sortOrdersMap[sortKey] || [];

                const orderedIdSet = new Set(currentItemOrder);
                const combinedOrder = [...currentItemOrder];
                for(const record of records) { 
                    const id = record[itemColumnName];
                    if(!orderedIdSet.has(id)) combinedOrder.push(id);
                }

                const displayOrder = combinedOrder.filter(id => customRows.has(id) || currentRecordIds.has(id));
                const visibleIds = new Set(displayOrder.filter(id => !hiddenItemIds.has(id)));

                if (visibleIds.size === 0) {
                    tableEl.classList.add('hidden'); noDataEl.classList.remove('hidden'); return;
                }

                noDataEl.classList.add('hidden'); tableEl.classList.remove('hidden');
                
                const headers = allRecords.length > 0 ? Object.keys(allRecords[0]) : [];
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = `px-2 sm:px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${header === itemColumnName ? 'w-2/5' : 'w-auto'}`;
                    th.textContent = header.replace(/_/g, ' ');
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);
                
                displayOrder.forEach(id => {
                    if (!visibleIds.has(id)) return;

                    if(customRows.has(id)){
                        const rowData = customRows.get(id);
                        if (rowData.categoryName === activeCategoryName) {
                            const row = document.createElement('tr');
                            row.dataset.id = id;
                            row.className = 'bg-gray-200 font-bold';
                            
                            const cell = document.createElement('td');
                            cell.colSpan = headers.length;
                            cell.className = 'px-4 py-2 text-gray-800';
                            
                            const contentWrapper = document.createElement('div');
                            contentWrapper.className = 'flex justify-between items-center';
                            
                            const textSpan = document.createElement('span');
                            textSpan.textContent = rowData.text;
                            
                            const buttonsWrapper = document.createElement('div');

                            const editBtn = document.createElement('button');
                            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>`;
                            editBtn.className = 'ml-2 text-gray-500 hover:text-blue-600 focus:outline-none';
                            editBtn.onclick = (e) => { e.stopPropagation(); editHeaderRow(id, rowData.text); };

                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                            deleteBtn.className = 'ml-1 text-gray-500 hover:text-red-600 focus:outline-none';
                            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteHeaderRow(id); };

                            buttonsWrapper.append(editBtn, deleteBtn);
                            contentWrapper.append(textSpan, buttonsWrapper);
                            cell.appendChild(contentWrapper);
                            row.appendChild(cell);
                            tableBody.appendChild(row);
                        }
                    } else if (allRecordsMap.has(id)) {
                        const record = allRecordsMap.get(id);
                        const row = document.createElement('tr');
                        row.dataset.id = id; 
                        row.className = 'hover:bg-gray-50';
                        row.addEventListener('dblclick', () => hideItem(id));
                        headers.forEach(header => {
                            const td = document.createElement('td');
                            td.className = `px-2 sm:px-6 py-2 text-sm text-gray-700 whitespace-normal break-all ${header === itemColumnName ? 'w-2/5' : 'w-auto'}`;
                            td.textContent = record[header];
                            row.appendChild(td);
                        });
                        tableBody.appendChild(row);
                    }
                });

                sortableInstance = new Sortable(tableBody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    delay: 200,
                    delayOnTouchOnly: true,
                    touchStartThreshold: 5,
                    onEnd: (evt) => {
                        const newOrder = Array.from(tableBody.querySelectorAll('tr')).map(row => row.dataset.id);
                        saveCurrentSortOrder(newOrder);
                    }
                });
                updateShowHiddenButtonVisibility();
            }

            function showError(message) {
                errorMessageEl.textContent = `เกิดข้อผิดพลาด: ${message}`;
                errorEl.classList.remove('hidden');
            }

            function showNoData() {
                noDataEl.querySelector('p').textContent = 'ไม่พบข้อมูล';
                noDataEl.classList.remove('hidden'); tableEl.classList.add('hidden');
            }

            function updateShowHiddenButtonVisibility() {
                showHiddenBtn.classList.toggle('hidden', hiddenItemIds.size === 0);
            }
            
            // --- General Event Listeners ---
            addCategoryBtn.addEventListener('click', addCategory);
            addHeaderBtn.addEventListener('click', addHeaderRow);
            categoryInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addCategory(); });
            clearFilterBtn.addEventListener('click', () => {
                noDataEl.querySelector('p').textContent = 'ไม่พบข้อมูล';
                activeCategoryName = null;
                displayData(allRecords);
                clearFilterBtn.classList.add('hidden');
                document.querySelectorAll('#category-list > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
            });
            showHiddenBtn.addEventListener('click', () => {
                const itemsToUnhide = (activeCategoryName ? currentRecords : allRecords)
                    .map(record => record[itemColumnName])
                    .filter(id => hiddenItemIds.has(id));
                if (itemsToUnhide.length > 0) unhideItems(itemsToUnhide);
            });
        });
    </script>

</body>
</html>

